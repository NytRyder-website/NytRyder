<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Nyt Ryder ¬∑ Eastern Cape</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0a0e1a;
            --surface: #141e2c;
            --card: #1f2a3c;
            --accent: #7c4dff;
            --accent2: #9b7aff;
            --text: #ffffff;
            --text-sec: #b1bddb;
            --border: #2c3850;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text);
            font-size: 15px;
            overflow-x: hidden;
        }
        .app {
            position: relative;
            width: 100%;
            min-height: 100vh;
        }
        .page {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding-bottom: 90px;
            animation: fadeIn 0.3s ease;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .header {
            background: var(--surface);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .back-btn {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); }
        .header-title {
            font-weight: 700;
            font-size: 20px;
            flex: 1;
        }
        .logo {
            display: flex; align-items: center; gap: 8px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(145deg, var(--accent), #a27cff);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800;
        }
        .auth-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
        }
        .auth-buttons { display: flex; gap: 8px; }
        .auth-btn {
            padding: 10px 18px; border-radius: 40px; font-weight: 600;
            border: 1.5px solid var(--border); background: transparent; color: white;
            cursor: pointer;
        }
        .auth-btn.register { background: var(--accent); border-color: var(--accent); }
        .user-profile {
            display: flex; align-items: center; gap: 8px; background: var(--card);
            padding: 6px 16px 6px 8px; border-radius: 50px;
        }
        .avatar { width: 38px; height: 38px; border-radius: 38px; background: var(--accent); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .container { padding: 18px; }

        .search-card {
            background: var(--surface);
            border-radius: 32px;
            padding: 22px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-field {
            background: var(--card);
            border-radius: 60px;
            padding: 6px 18px 6px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .search-field i { color: var(--accent); font-size: 18px; }
        .search-field input, .search-field select {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            padding: 16px 0;
            width: 100%;
            outline: none;
        }
        .results-dropdown {
            max-height: 250px;
            overflow-y: auto;
            background: var(--card);
            border-radius: 28px;
            margin: 4px 0 16px;
            display: none;
            border: 1px solid var(--border);
        }
        .results-dropdown div {
            padding: 16px 22px;
            border-bottom: 1px solid #2f3a4f;
            font-weight: 500;
            cursor: pointer;
        }
        .results-dropdown div:hover { background: rgba(124,77,255,0.2); }
        .results-dropdown div i { margin-right: 12px; color: var(--accent); }

        .area-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 24px;
        }
        .pill {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .pill i { color: var(--accent); margin-right: 6px; }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            border: none;
            border-radius: 60px;
            padding: 18px;
            font-weight: 700;
            font-size: 18px;
            color: white;
            box-shadow: 0 12px 30px rgba(124,77,255,0.4);
            margin-top: 16px;
            cursor: pointer;
        }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); }

        .fare-card {
            background: #1b253b;
            border-radius: 40px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .fare-amount { font-size: 42px; font-weight: 800; }

        .driver-card {
            background: linear-gradient(145deg, #1f2c41, #17212f);
            border-radius: 32px;
            padding: 24px;
            margin-top: 30px;
            border: 1px solid #3a4865;
        }
        .driver-selfie {
            width: 90px; height: 90px;
            border-radius: 90px;
            border: 4px solid var(--accent);
            overflow: hidden;
        }
        .driver-selfie img { width:100%; height:100%; object-fit: cover; }
        .contact-row {
            display: flex; gap: 16px; margin-top: 16px; justify-content: center;
            flex-wrap: wrap;
        }
        .contact-phone {
            background: #2a364f; padding: 14px 24px; border-radius: 50px; font-weight: 600;
        }

        .history-item, .ride-item, .profile-card {
            background: var(--card);
            border-radius: 24px;
            padding: 18px;
            margin-bottom: 12px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 18px;
            border-top: 1px solid var(--border);
            z-index: 99;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sec); cursor: pointer;
        }
        .nav-item.active { color: var(--accent); }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96); display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 16px;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card {
            background: var(--surface); border-radius: 48px; padding: 28px 22px;
            width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        .selfie-upload {
            background: var(--card); border: 2px dashed var(--accent); border-radius: 40px; padding: 20px; text-align: center;
            margin-bottom: 20px;
        }
        .selfie-preview {
            width: 120px; height: 120px; border-radius: 120px; margin: 0 auto 16px;
            background: #1a253f; overflow: hidden; border: 4px solid var(--accent);
        }
        .selfie-preview img { width:100%; height:100%; object-fit: cover; }
        
        .debug-panel {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 12px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #a0a0a0;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
<div class="app">

    <!-- ========== HOME PAGE ========== -->
    <div id="homePage" class="page active">
        <div class="auth-row">
            <div class="logo">
                <div class="logo-icon">NR</div>
                <div class="logo-text">Nyt<span>Ryder</span></div>
            </div>
            <div id="homeAuth">
                <div class="auth-buttons" id="homeAuthBtns">
                    <button class="auth-btn" id="homeLoginBtn">Log in</button>
                    <button class="auth-btn register" id="homeRegisterBtn">Sign up</button>
                </div>
                <div class="user-profile" id="homeUserProfile" style="display:none;">
                    <div class="avatar" id="homeAvatar">
                        <img id="homeAvatarImg" style="display:none;">
                        <div id="homeAvatarInitials">JD</div>
                    </div>
                    <span id="homeUserName">User</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="search-card">
                <div class="search-field">
                    <i class="fas fa-circle"></i>
                    <input type="text" id="homePickup" placeholder="Pickup (e.g., Qonce CBD)" autocomplete="off">
                </div>
                <div class="results-dropdown" id="homePickupResults"></div>
                
                <div class="search-field">
                    <i class="fas fa-flag"></i>
                    <input type="text" id="homeDest" placeholder="Destination" autocomplete="off">
                </div>
                <div class="results-dropdown" id="homeDestResults"></div>

                <!-- Qonce area pills -->
                <div class="area-pills" id="homePills"></div>

                <!-- Admin login button below pills -->
                <button class="btn-outline" id="homeAdminBtn" style="width:100%; margin-bottom:16px;">
                    <i class="fas fa-user-shield"></i> Admin
                </button>

                <div class="search-field">
                    <i class="fas fa-clock"></i>
                    <select id="homeTime">
                        <option>Now</option>
                        <option>22:00</option>
                        <option>23:00</option>
                        <option>00:00</option>
                        <option>01:00</option>
                    </select>
                </div>

                <button class="btn-primary" id="homeEstimateBtn">
                    <i class="fas fa-calculator"></i> Estimate fare
                </button>

                <div class="fare-card" id="homeFareCard">
                    <div class="fare-amount" id="homeFareAmount">R 0</div>
                    <div id="homeFareDetail" style="margin:12px 0;"></div>
                    <button class="btn-primary btn-success" id="homeConfirmBtn">Confirm & continue</button>
                </div>
            </div>
            
            <!-- Debug panel - shows registered users -->
            <div class="debug-panel" id="debugPanel">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <strong>üîç Registered Users (0)</strong>
                    <button id="refreshDebugBtn" style="background:transparent; border:none; color:var(--accent);">‚Üª</button>
                </div>
                <div id="debugUserList">No registered users yet</div>
                <div style="margin-top:8px;">
                    <button id="clearAllUsersBtn" style="background:#ff4444; border:none; color:white; padding:4px 8px; border-radius:8px; font-size:10px;">Clear all users</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== BOOKING PAGE ========== -->
    <div id="bookingPage" class="page">
        <div class="header">
            <button class="back-btn" id="bookingBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Confirm booking</div>
        </div>
        <div class="container">
            <div class="search-card">
                <div id="bookingDetails" style="margin-bottom:20px;"></div>
                <button class="btn-primary" id="bookingConfirmBtn"><i class="fas fa-check"></i> Book now</button>
            </div>
        </div>
    </div>

    <!-- ========== RIDE PAGE (current ride) ========== -->
    <div id="ridePage" class="page">
        <div class="header">
            <button class="back-btn" id="rideBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Current ride</div>
        </div>
        <div class="container">
            <div id="currentRideContainer"></div>
            <div class="driver-card" id="rideDriverCard" style="display:none;"></div>
        </div>
    </div>

    <!-- ========== HISTORY PAGE ========== -->
    <div id="historyPage" class="page">
        <div class="header">
            <button class="back-btn" id="historyBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Your trips</div>
        </div>
        <div class="container">
            <div id="historyList"></div>
            <div id="totalSpent" style="font-weight:700; margin-top:20px;"></div>
        </div>
    </div>

    <!-- ========== PROFILE PAGE ========== -->
    <div id="profilePage" class="page">
        <div class="header">
            <button class="back-btn" id="profileBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Profile</div>
        </div>
        <div class="container">
            <div class="profile-card" id="profileCard"></div>
            <button class="btn-outline" id="logoutBtn" style="margin-top:20px;">Log out</button>
        </div>
    </div>

    <!-- ========== ADMIN PAGE ========== -->
    <div id="adminPage" class="page">
        <div class="header">
            <button class="back-btn" id="adminBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Admin control</div>
        </div>
        <div class="container">
            <div class="search-field">
                <i class="fas fa-lock"></i>
                <input type="password" id="adminCodeInput" placeholder="Admin code">
            </div>
            <button class="btn-primary" id="adminLoginPageBtn">Login</button>
            
            <div id="adminDashboard" style="display:none; margin-top:24px;">
                <h4 style="margin-bottom:16px;">Ride requests</h4>
                <div id="adminRideList"></div>
                
                <h4 style="margin:24px 0 16px;">Update ETA</h4>
                <select id="adminEtaSelect" class="search-field">
                    <option>5 min</option>
                    <option>10 min</option>
                    <option>15 min</option>
                    <option>20 min</option>
                </select>
                <button class="btn-primary" id="adminUpdateEta">Update ETA for all rides</button>
            </div>
        </div>
    </div>

    <!-- ========== REGISTER MODAL (name + phone only) ========== -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Sign up</h3>
            <div class="selfie-upload">
                <div class="selfie-preview">
                    <img id="regSelfieImg" style="display:none;">
                    <div id="regSelfiePlaceholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:32px;">üì∏</div>
                </div>
                <button class="btn-outline" id="regUploadBtn" style="margin-bottom:8px;">Upload selfie</button>
                <input type="file" id="regSelfieInput" accept="image/*" capture="user" style="display:none;">
                <div class="text-small" style="color:var(--text-sec);">Selfie required</div>
            </div>

            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="regName" placeholder="Full name">
            </div>
            
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-phone"></i>
                <input id="regPhone" placeholder="Phone number (e.g., 0767094033)">
            </div>

            <button class="btn-primary" id="regSubmit">Create account</button>
            <button class="btn-outline" id="closeRegisterModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <!-- ========== LOGIN MODAL (name + phone only) ========== -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Log in</h3>
            
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="loginName" placeholder="Full name">
            </div>
            
            <div class="search-field" style="margin-bottom:20px;">
                <i class="fas fa-phone"></i>
                <input id="loginPhone" placeholder="Phone number">
            </div>

            <button class="btn-primary" id="loginSubmit">Login</button>
            <button class="btn-outline" id="closeLoginModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <!-- bottom navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-page="homePage"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" data-page="ridePage"><i class="fas fa-car"></i><span>Ride</span></div>
        <div class="nav-item" data-page="historyPage"><i class="fas fa-history"></i><span>History</span></div>
        <div class="nav-item" data-page="profilePage"><i class="fas fa-user"></i><span>Profile</span></div>
    </div>
</div>

<script>
(function() {
    // ========== CLEAN SLATE - NO PRE-LOADED USERS ==========
    // Clear any existing data on first load to ensure clean slate
    if (!localStorage.getItem('nr_initialized')) {
        localStorage.removeItem('nr_users');
        localStorage.removeItem('nr_rides');
        localStorage.removeItem('nr_current');
        localStorage.setItem('nr_initialized', 'true');
    }

    // ========== EASTERN CAPE LOCATIONS ==========
    const ecPlaces = [
        "Qonce CBD", "Qonce (King William's Town)", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim",
        "Keiskammahoek", "Dimbaza", "Alice", "Fort Beaufort", "Adelaide", "Bedford", "Cradock", "Tarkastad",
        "Queenstown", "Cofimvaba", "Dutywa", "Butterworth", "Idutywa", "Mthatha", "Libode", "Ngqeleni",
        "Port St Johns", "Lusikisiki", "Flagstaff", "Mount Ayliff", "Mount Frere", "Kokstad", "Matatiele",
        "Mount Fletcher", "Maclear", "Elliot", "Ugie", "Calcutta", "Gonubie", "East London", "Cambridge",
        "Amalinda", "Nahoon", "Beacon Bay", "Vincent", "Duncan Village", "KwaNobuhle", "KwaDwesi",
        "KwaZakhele", "Motherwell", "Uitenhage", "Despatch", "Gqeberha", "Walmer", "Summerstrand",
        "Humansdorp", "Jeffreys Bay", "St Francis Bay", "Cape St Francis", "Patensie", "Hankey",
        "Kirkwood", "Addo", "Colchester", "Graaff-Reinet", "Nieu-Bethesda", "Aberdeen", "Jansenville",
        "Willowmore", "Steytlerville", "Uniondale", "Klipplaat", "Murraysburg", "Richmond",
        "Middelburg EC", "Noupoort", "Colesberg", "Venterstad", "Burgersdorp", "Aliwal North",
        "Lady Grey", "Barkly East", "Rhodes", "Dordrecht", "Indwe", "Molteno", "Sterkstroom",
        "Hofmeyr", "Somerset East", "Cookhouse", "Pearston", "Kirkwood", "Addo", "Paterson",
        "Alexandria", "Bathurst", "Port Alfred", "Kenton-on-Sea", "Bushman's River Mouth",
        "Marselle", "Ebb and Flow", "Tsitsikamma", "Storms River", "Nature's Valley",
        "Kareedouw", "Joubertina", "Misgund", "Louterwater", "Harkerville", "Knysna",
        "Plettenberg Bay", "Wittedrift", "Kranshoek", "Keurboomstrand", "The Crags"
    ];
    const allEC = [...new Set(ecPlaces)].sort();

    // Qonce area pills
    const qoncePills = ["Qonce CBD", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim", "Keiskammahoek", "Dimbaza", "East London", "Mthatha"];
    const pillDiv = document.getElementById('homePills');
    qoncePills.forEach(place => {
        let p = document.createElement('span');
        p.className = 'pill';
        p.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${place}`;
        p.onclick = () => {
            if (!document.getElementById('homePickup').value) {
                document.getElementById('homePickup').value = place;
            } else if (!document.getElementById('homeDest').value) {
                document.getElementById('homeDest').value = place;
            }
        };
        pillDiv.appendChild(p);
    });

    // ========== STORAGE ==========
    let users = JSON.parse(localStorage.getItem('nr_users')) || [];
    let rides = JSON.parse(localStorage.getItem('nr_rides')) || [];
    let currentUser = JSON.parse(localStorage.getItem('nr_current'));

    const DRIVER = {
        name: "Mziwovuyo Mei",
        phone1: "076 709 4033",
        phone2: "043 065 0097",
        car: "Ford Fiesta White",
        plate: "DCW 449 NC",
        selfie: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2325384d'/%3E%3Ccircle cx='50' cy='30' r='16' fill='%233d556b'/%3E%3Ccircle cx='35' cy='24' r='4' fill='%23fff'/%3E%3Ccircle cx='65' cy='24' r='4' fill='%23fff'/%3E%3Cpath d='M38 44 Q50 58,62 44' stroke='%23fff' stroke-width='5' fill='none'/%3E%3C/svg%3E"
    };

    // ========== DEBUG FUNCTION - SHOW REGISTERED USERS ==========
    function updateDebugPanel() {
        let debugPanel = document.getElementById('debugPanel');
        let debugList = document.getElementById('debugUserList');
        
        if (users.length === 0) {
            debugList.innerHTML = '<div style="color:#888;">No registered users</div>';
            document.querySelector('.debug-panel strong').innerText = 'üîç Registered Users (0)';
        } else {
            debugList.innerHTML = users.map(u => `
                <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #333;">
                    <span>üë§ ${u.name}</span>
                    <span>üì± ${u.phone}</span>
                    <span style="color:#0f0;">‚úì</span>
                </div>
            `).join('');
            document.querySelector('.debug-panel strong').innerText = `üîç Registered Users (${users.length})`;
        }
    }

    // Show debug panel
    document.getElementById('debugPanel').style.display = 'block';
    updateDebugPanel();

    document.getElementById('refreshDebugBtn').onclick = updateDebugPanel;
    
    document.getElementById('clearAllUsersBtn').onclick = () => {
        if (confirm('Clear all users? This will delete all registered accounts.')) {
            users = [];
            rides = [];
            currentUser = null;
            localStorage.setItem('nr_users', JSON.stringify(users));
            localStorage.setItem('nr_rides', JSON.stringify(rides));
            localStorage.removeItem('nr_current');
            updateDebugPanel();
            updateAuthUI();
            alert('All users cleared. You can now register fresh.');
        }
    };

    // ========== PAGE ROUTER ==========
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        let activeNav = Array.from(document.querySelectorAll('.nav-item')).find(n => n.dataset.page === pageId);
        if (activeNav) activeNav.classList.add('active');
        
        window.scrollTo(0, 0);
        
        if (pageId === 'historyPage' && currentUser) loadHistory();
        if (pageId === 'profilePage' && currentUser) loadProfile();
        if (pageId === 'ridePage') loadCurrentRide();
    }

    // Back buttons
    document.getElementById('bookingBack').onclick = () => showPage('homePage');
    document.getElementById('rideBack').onclick = () => showPage('homePage');
    document.getElementById('historyBack').onclick = () => showPage('homePage');
    document.getElementById('profileBack').onclick = () => showPage('homePage');
    document.getElementById('adminBack').onclick = () => showPage('homePage');

    // Bottom navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            let page = item.dataset.page;
            if (page === 'profilePage' || page === 'historyPage' || page === 'ridePage') {
                if (!currentUser) {
                    alert('Please login first');
                    document.getElementById('loginModal').classList.add('active');
                    return;
                }
            }
            showPage(page);
        });
    });

    // ========== LOCATION SEARCH ==========
    function filterPlaces(query) { 
        if (!query) return []; 
        return allEC.filter(p => p.toLowerCase().includes(query.toLowerCase())).slice(0, 12); 
    }

    const pickup = document.getElementById('homePickup');
    const dest = document.getElementById('homeDest');
    const pickupRes = document.getElementById('homePickupResults');
    const destRes = document.getElementById('homeDestResults');

    function setupSearch(input, res) {
        input.addEventListener('input', () => {
            let matches = filterPlaces(input.value);
            if (matches.length) {
                res.innerHTML = matches.map(p => `<div><i class="fas fa-location-dot"></i> ${p}</div>`).join('');
                res.style.display = 'block';
                Array.from(res.children).forEach(div => {
                    div.onclick = () => { 
                        input.value = div.innerText.trim(); 
                        res.style.display = 'none'; 
                    };
                });
            } else {
                res.style.display = 'none';
            }
        });
        
        document.addEventListener('click', (e) => { 
            if (!res.contains(e.target) && e.target !== input) {
                res.style.display = 'none'; 
            }
        });
    }
    setupSearch(pickup, pickupRes);
    setupSearch(dest, destRes);

    // ========== FARE CALCULATION ==========
    function calculateFare(pickup, dest) {
        let dist = Math.floor(Math.random() * 40 + 15); // 15-55 km
        return { amount: dist * 15, distance: dist };
    }

    let lastEstimate = null;
    document.getElementById('homeEstimateBtn').onclick = () => {
        let p = pickup.value.trim();
        let d = dest.value.trim();
        if (!p || !d) { 
            alert('Please enter pickup and destination'); 
            return; 
        }
        let { amount, distance } = calculateFare(p, d);
        document.getElementById('homeFareAmount').innerText = 'R ' + amount;
        document.getElementById('homeFareDetail').innerHTML = `${p} ‚Üí ${d}<br>${distance} km ¬∑ 15-25 min`;
        document.getElementById('homeFareCard').style.display = 'block';
        lastEstimate = { pickup: p, dest: d, amount, distance };
    };

    // Confirm goes to booking page
    document.getElementById('homeConfirmBtn').onclick = () => {
        if (!lastEstimate) return;
        if (!currentUser) {
            document.getElementById('loginModal').classList.add('active');
            return;
        }
        document.getElementById('bookingDetails').innerHTML = `
            <div style="background:var(--card); border-radius:24px; padding:20px;">
                <p style="font-size:18px; margin-bottom:12px;"><strong>${lastEstimate.pickup}</strong> <i class="fas fa-arrow-right" style="color:var(--accent);"></i> <strong>${lastEstimate.dest}</strong></p>
                <p style="font-size:24px; font-weight:700; color:var(--accent);">R${lastEstimate.amount}</p>
                <p>Distance: ${lastEstimate.distance} km</p>
                <p>Time: ${document.getElementById('homeTime').value}</p>
            </div>
        `;
        showPage('bookingPage');
    };

    // Book now
    document.getElementById('bookingConfirmBtn').onclick = () => {
        if (!currentUser || !lastEstimate) return;
        
        let newRide = {
            id: 'r' + Date.now(),
            userId: currentUser.id,
            userName: currentUser.name,
            userPhone: currentUser.phone,
            pickup: lastEstimate.pickup,
            dest: lastEstimate.dest,
            amount: lastEstimate.amount,
            distance: lastEstimate.distance,
            status: 'pending',
            time: new Date().toLocaleString(),
            driverETA: '12 min'
        };
        
        rides.push(newRide);
        localStorage.setItem('nr_rides', JSON.stringify(rides));
        
        alert('Ride booked successfully! Driver Mziwovuyo Mei is on the way.');
        showPage('homePage');
        document.getElementById('homeFareCard').style.display = 'none';
    };

    // ========== CURRENT RIDE ==========
    function loadCurrentRide() {
        if (!currentUser) return;
        
        let active = rides.filter(r => r.userId === currentUser.id && (r.status === 'pending' || r.status === 'accepted'));
        let container = document.getElementById('currentRideContainer');
        
        if (active.length) {
            let r = active[0];
            container.innerHTML = `
                <div class="ride-item">
                    <p style="font-size:18px; margin-bottom:8px;"><strong>${r.pickup} ‚Üí ${r.dest}</strong></p>
                    <p style="color:var(--text-sec);">Fare: R${r.amount} | Status: <span style="color:${r.status === 'accepted' ? 'var(--success)' : 'var(--warning)'};">${r.status}</span></p>
                    <p style="color:var(--text-sec);">Driver ETA: <span id="liveEta" style="color:white; font-weight:700;">${r.driverETA}</span></p>
                </div>
            `;
            
            document.getElementById('rideDriverCard').style.display = 'block';
            document.getElementById('rideDriverCard').innerHTML = `
                <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
                    <div class="driver-selfie"><img src="${DRIVER.selfie}"></div>
                    <div>
                        <div style="font-size:20px; font-weight:700;">${DRIVER.name}</div>
                        <div style="color:var(--text-sec);">${DRIVER.car}</div>
                        <div style="font-family:monospace; font-size:18px; margin-top:4px;">${DRIVER.plate}</div>
                    </div>
                </div>
                <div class="contact-row">
                    <div class="contact-phone"><i class="fas fa-phone-alt"></i> ${DRIVER.phone1}</div>
                    <div class="contact-phone"><i class="fas fa-phone-alt"></i> ${DRIVER.phone2}</div>
                </div>
            `;
        } else {
            container.innerHTML = '<div class="ride-item">No active ride</div>';
            document.getElementById('rideDriverCard').style.display = 'none';
        }
    }

    // ========== HISTORY ==========
    function loadHistory() {
        if (!currentUser) return;
        
        let userRides = rides.filter(r => r.userId === currentUser.id);
        let list = document.getElementById('historyList');
        
        if (userRides.length) {
            list.innerHTML = userRides.reverse().map(r => `
                <div class="history-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <strong>${r.pickup} ‚Üí ${r.dest}</strong>
                        <span style="color:var(--accent); font-weight:700;">R${r.amount}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; color:var(--text-sec); font-size:14px;">
                        <span>${r.time}</span>
                        <span style="color:${r.status === 'completed' ? 'var(--success)' : r.status === 'pending' ? 'var(--warning)' : 'var(--accent)'};">${r.status}</span>
                    </div>
                </div>
            `).join('');
            
            let total = userRides.reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('totalSpent').innerHTML = `Total spent: <span style="color:var(--accent);">R${total}</span>`;
        } else {
            list.innerHTML = '<div class="history-item">No trips yet</div>';
            document.getElementById('totalSpent').innerHTML = '';
        }
    }

    // ========== PROFILE ==========
    function loadProfile() {
        if (!currentUser) return;
        
        let card = document.getElementById('profileCard');
        card.innerHTML = `
            <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px;">
                <div class="avatar" style="width:70px; height:70px;">
                    ${currentUser.selfie ? 
                        `<img src="${currentUser.selfie}" style="width:100%; height:100%; object-fit:cover;">` : 
                        `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:var(--accent); font-size:24px;">${currentUser.name.charAt(0)}</div>`
                    }
                </div>
                <div>
                    <div style="font-size:20px; font-weight:700; margin-bottom:4px;">${currentUser.name}</div>
                    <div style="color:var(--text-sec);"><i class="fas fa-phone"></i> ${currentUser.phone}</div>
                    <div style="color:var(--text-sec); margin-top:4px;">Member since ${new Date(currentUser.createdAt || Date.now()).toLocaleDateString()}</div>
                </div>
            </div>
            <div style="background:var(--surface); border-radius:20px; padding:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Total rides:</span>
                    <span style="font-weight:700;">${rides.filter(r => r.userId === currentUser.id).length}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Total spent:</span>
                    <span style="font-weight:700; color:var(--accent);">R${rides.filter(r => r.userId === currentUser.id).reduce((s, r) => s + r.amount, 0)}</span>
                </div>
            </div>
        `;
    }

    // ========== AUTH (Name + Phone only) ==========
    function updateAuthUI() {
        const homeAuthBtns = document.getElementById('homeAuthBtns');
        const homeProfile = document.getElementById('homeUserProfile');
        const homeName = document.getElementById('homeUserName');
        const homeAvatarImg = document.getElementById('homeAvatarImg');
        const homeInitials = document.getElementById('homeAvatarInitials');

        if (currentUser) {
            homeAuthBtns.style.display = 'none';
            homeProfile.style.display = 'flex';
            homeName.innerText = currentUser.name.split(' ')[0];
            
            if (currentUser.selfie) {
                homeAvatarImg.src = currentUser.selfie;
                homeAvatarImg.style.display = 'block';
                homeInitials.style.display = 'none';
            } else {
                homeAvatarImg.style.display = 'none';
                homeInitials.style.display = 'flex';
                homeInitials.innerText = currentUser.name.charAt(0);
            }
        } else {
            homeAuthBtns.style.display = 'flex';
            homeProfile.style.display = 'none';
        }
    }

    // Modal controls
    document.getElementById('homeLoginBtn').onclick = () => {
        document.getElementById('loginModal').classList.add('active');
    };
    
    document.getElementById('homeRegisterBtn').onclick = () => {
        document.getElementById('registerModal').classList.add('active');
    };
    
    document.getElementById('homeAdminBtn').onclick = () => showPage('adminPage');
    
    document.getElementById('closeLoginModal').onclick = () => {
        document.getElementById('loginModal').classList.remove('active');
        // Clear login fields
        document.getElementById('loginName').value = '';
        document.getElementById('loginPhone').value = '';
    };
    
    document.getElementById('closeRegisterModal').onclick = () => {
        document.getElementById('registerModal').classList.remove('active');
        // Clear register fields
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        selfieData = null;
    };

    // Selfie upload
    let selfieData = null;
    document.getElementById('regUploadBtn').onclick = () => document.getElementById('regSelfieInput').click();
    
    document.getElementById('regSelfieInput').onchange = function(e) {
        let file = e.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = (ev) => {
                selfieData = ev.target.result;
                document.getElementById('regSelfieImg').src = ev.target.result;
                document.getElementById('regSelfieImg').style.display = 'block';
                document.getElementById('regSelfiePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    };

    // Register - FIXED: ensure data is saved correctly
    document.getElementById('regSubmit').onclick = () => {
        let name = document.getElementById('regName').value.trim();
        let phone = document.getElementById('regPhone').value.trim();
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        if (!selfieData) {
            alert('Selfie is required');
            return;
        }
        
        // Check if phone already exists
        if (users.find(u => u.phone === phone)) {
            alert('Phone number already registered. Please login.');
            return;
        }
        
        let newUser = { 
            id: 'u' + Date.now(), 
            name: name, 
            phone: phone, 
            selfie: selfieData,
            createdAt: new Date().toISOString()
        };
        
        users.push(newUser);
        localStorage.setItem('nr_users', JSON.stringify(users));
        
        // Auto login after registration
        currentUser = newUser;
        localStorage.setItem('nr_current', JSON.stringify(currentUser));
        
        updateAuthUI();
        updateDebugPanel();
        document.getElementById('registerModal').classList.remove('active');
        
        // Clear form
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        selfieData = null;
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        
        alert('Registration successful! You are now logged in.');
    };

    // Login - FIXED: better matching
    document.getElementById('loginSubmit').onclick = () => {
        let name = document.getElementById('loginName').value.trim();
        let phone = document.getElementById('loginPhone').value.trim();
        
        console.log('Login attempt - Name:', name, 'Phone:', phone);
        console.log('Current users in storage:', users);
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        // Clean phone number (remove spaces, dashes)
        let cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        // Find user by name AND phone - try different matching strategies
        let user = users.find(u => 
            u.name.toLowerCase().trim() === name.toLowerCase().trim() && 
            (u.phone === phone || u.phone.replace(/[\s\-\(\)]/g, '') === cleanPhone)
        );
        
        if (user) {
            console.log('User found:', user);
            currentUser = user;
            localStorage.setItem('nr_current', JSON.stringify(currentUser));
            updateAuthUI();
            document.getElementById('loginModal').classList.remove('active');
            
            // Clear form
            document.getElementById('loginName').value = '';
            document.getElementById('loginPhone').value = '';
            
            alert('Welcome back, ' + user.name + '!');
        } else {
            console.log('No user found with name:', name, 'and phone:', phone);
            console.log('Available users:', users.map(u => ({name: u.name, phone: u.phone})));
            alert('No account found with that name and phone number. Please register first.');
        }
    };

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
        currentUser = null;
        localStorage.removeItem('nr_current');
        updateAuthUI();
        showPage('homePage');
        alert('Logged out successfully');
    };

    // ========== ADMIN ==========
    document.getElementById('adminLoginPageBtn').onclick = () => {
        if (document.getElementById('adminCodeInput').value === '548755') {
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminRides();
        } else {
            alert('Invalid admin code');
        }
    };

    function renderAdminRides() {
        let pending = rides.filter(r => r.status === 'pending');
        let list = document.getElementById('adminRideList');
        
        if (pending.length) {
            list.innerHTML = pending.map(r => `
                <div class="ride-item" style="margin-bottom:16px;">
                    <p><strong>${r.pickup} ‚Üí ${r.dest}</strong></p>
                    <p>R${r.amount} | User: ${r.userName || 'Unknown'}</p>
                    <p style="color:var(--text-sec); font-size:14px;">${r.userPhone || ''}</p>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="auth-btn" style="background:green; color:white; border:none;" onclick="acceptRide('${r.id}')">Accept</button>
                        <button class="auth-btn" style="background:red; color:white; border:none;" onclick="declineRide('${r.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        } else {
            list.innerHTML = '<div class="ride-item">No pending rides</div>';
        }
    }

    window.acceptRide = (id) => {
        let ride = rides.find(r => r.id === id);
        if (ride) { 
            ride.status = 'accepted'; 
            ride.driverETA = document.getElementById('adminEtaSelect').value;
        }
        localStorage.setItem('nr_rides', JSON.stringify(rides));
        renderAdminRides();
        alert('Ride accepted');
    };

    window.declineRide = (id) => {
        rides = rides.filter(r => r.id !== id);
        localStorage.setItem('nr_rides', JSON.stringify(rides));
        renderAdminRides();
        alert('Ride declined');
    };

    document.getElementById('adminUpdateEta').onclick = () => {
        let eta = document.getElementById('adminEtaSelect').value;
        rides.filter(r => r.status === 'accepted').forEach(r => r.driverETA = eta);
        localStorage.setItem('nr_rides', JSON.stringify(rides));
        alert('ETA updated for all accepted rides');
    };

    // Initialize
    updateAuthUI();
    if (currentUser) {
        loadCurrentRide();
    }
})();
</script>
</body>
</html>
