<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Nyt Ryder Â· Eastern Cape (Auto Location)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaZRWE6JxhEJboPPnBDJO3uo_WepqYazg&libraries=places&callback=initMap&v=weekly" async defer></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0a0e1a;
            --surface: #141e2c;
            --card: #1f2a3c;
            --accent: #7c4dff;
            --accent2: #9b7aff;
            --text: #ffffff;
            --text-sec: #b1bddb;
            --border: #2c3850;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --notification: #ff4757;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text);
            font-size: 15px;
            overflow-x: hidden;
        }
        .app {
            position: relative;
            width: 100%;
            min-height: 100vh;
        }
        .page {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding-bottom: 90px;
            animation: fadeIn 0.3s ease;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .header {
            background: var(--surface);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .back-btn {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); }
        .header-title {
            font-weight: 700;
            font-size: 20px;
            flex: 1;
        }
        .logo {
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(145deg, var(--accent), #a27cff);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800;
        }
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        .logo-brand {
            font-weight: 800;
            font-size: 18px;
            line-height: 1.2;
        }
        .logo-slogan {
            font-size: 10px;
            font-weight: 500;
            color: var(--accent2);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .auth-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
        }
        .auth-buttons { display: flex; gap: 8px; }
        .auth-btn {
            padding: 10px 18px; border-radius: 40px; font-weight: 600;
            border: 1.5px solid var(--border); background: transparent; color: white;
            cursor: pointer;
        }
        .auth-btn.register { background: var(--accent); border-color: var(--accent); }
        .user-profile {
            display: flex; align-items: center; gap: 8px; background: var(--card);
            padding: 6px 16px 6px 8px; border-radius: 50px;
        }
        .avatar { width: 38px; height: 38px; border-radius: 38px; background: var(--accent); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .container { padding: 18px; }

        .search-card {
            background: var(--surface);
            border-radius: 32px;
            padding: 22px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-field {
            background: var(--card);
            border-radius: 60px;
            padding: 6px 18px 6px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .search-field i { color: var(--accent); font-size: 18px; }
        .search-field input, .search-field select {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            padding: 16px 0;
            width: 100%;
            outline: none;
        }
        .location-action-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-right: 8px;
        }
        .location-action-btn:hover {
            background: var(--accent2);
            transform: scale(1.02);
        }
        .location-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .results-dropdown {
            max-height: 250px;
            overflow-y: auto;
            background: var(--card);
            border-radius: 28px;
            margin: 4px 0 16px;
            display: none;
            border: 1px solid var(--border);
        }
        .results-dropdown div {
            padding: 16px 22px;
            border-bottom: 1px solid #2f3a4f;
            font-weight: 500;
            cursor: pointer;
        }
        .results-dropdown div:hover { background: rgba(124,77,255,0.2); }
        .results-dropdown div i { margin-right: 12px; color: var(--accent); }

        .area-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 24px;
        }
        .pill {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .pill i { color: var(--accent); margin-right: 6px; }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            border: none;
            border-radius: 60px;
            padding: 18px;
            font-weight: 700;
            font-size: 18px;
            color: white;
            box-shadow: 0 12px 30px rgba(124,77,255,0.4);
            margin-top: 16px;
            cursor: pointer;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); }

        .fare-card {
            background: #1b253b;
            border-radius: 40px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .fare-amount { font-size: 42px; font-weight: 800; }

        .driver-card {
            background: linear-gradient(145deg, #1f2c41, #17212f);
            border-radius: 32px;
            padding: 24px;
            margin-top: 30px;
            border: 1px solid #3a4865;
        }
        .driver-selfie {
            width: 90px; height: 90px;
            border-radius: 90px;
            border: 4px solid var(--accent);
            overflow: hidden;
        }
        .driver-selfie img { width:100%; height:100%; object-fit: cover; }
        .contact-row {
            display: flex; gap: 16px; margin-top: 16px; justify-content: center;
            flex-wrap: wrap;
        }
        .contact-phone {
            background: #2a364f; padding: 14px 24px; border-radius: 50px; font-weight: 600;
        }

        .history-item, .ride-item, .profile-card {
            background: var(--card);
            border-radius: 24px;
            padding: 18px;
            margin-bottom: 12px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 18px;
            border-top: 1px solid var(--border);
            z-index: 99;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sec); cursor: pointer;
        }
        .nav-item.active { color: var(--accent); }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96); display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 16px;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card {
            background: var(--surface); border-radius: 48px; padding: 28px 22px;
            width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        .selfie-upload {
            background: var(--card); border: 2px dashed var(--accent); border-radius: 40px; padding: 20px; text-align: center;
            margin-bottom: 20px;
        }
        .selfie-preview {
            width: 120px; height: 120px; border-radius: 120px; margin: 0 auto 16px;
            background: #1a253f; overflow: hidden; border: 4px solid var(--accent);
        }
        .selfie-preview img { width:100%; height:100%; object-fit: cover; }
        
        .admin-debug-panel {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 12px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #a0a0a0;
            border: 1px solid #333;
        }
        .test-btn {
            background: #2a2a3a;
            border: 1px solid #444;
            color: #aaa;
            padding: 8px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
        }
        
        .notification-badge {
            background: var(--notification);
            color: white;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #ff6b81; }
            100% { transform: scale(1); }
        }
        
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification.warning {
            background: var(--notification);
        }

        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 10px;
            margin-right: 5px;
        }
        .connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .disconnected { background: var(--danger); }

        .loader {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .suggestion-chip {
            display: inline-block;
            background: var(--card);
            border: 1px solid var(--accent);
            border-radius: 30px;
            padding: 8px 16px;
            margin: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-chip:hover {
            background: var(--accent);
            transform: scale(1.05);
        }
        .api-status {
            background: var(--card);
            border-radius: 20px;
            padding: 12px;
            margin: 10px 0;
            font-size: 13px;
            border-left: 3px solid var(--warning);
        }
        .api-status.success {
            border-left-color: var(--success);
        }
        .api-status.error {
            border-left-color: var(--danger);
        }
        
        .rate-badge {
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .location-permission-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            width: 100%;
            justify-content: center;
        }
        .location-permission-btn i {
            font-size: 18px;
        }
        
        .location-status {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .location-status i {
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div id="toast" class="toast-notification"></div>

<div class="app">
    <div id="homePage" class="page active">
        <div class="auth-row">
            <div class="logo">
                <div class="logo-icon">NR</div>
                <div class="logo-text">
                    <div class="logo-brand">Nyt Ryder</div>
                    <div class="logo-slogan">Ride the Eastern Cape</div>
                </div>
            </div>
            <div id="homeAuth">
                <div class="auth-buttons" id="homeAuthBtns">
                    <button class="auth-btn" id="homeLoginBtn">Log in</button>
                    <button class="auth-btn register" id="homeRegisterBtn">Sign up</button>
                </div>
                <div class="user-profile" id="homeUserProfile" style="display:none;">
                    <div class="avatar" id="homeAvatar">
                        <img id="homeAvatarImg" style="display:none;">
                        <div id="homeAvatarInitials">JD</div>
                    </div>
                    <span id="homeUserName">User</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="search-card">
                <!-- Rate Badge -->
                <div class="rate-badge">
                    <i class="fas fa-tag"></i> R60 per km
                </div>

                <!-- Auto-Location Button -->
                <button class="location-permission-btn" id="detectLocationBtn">
                    <i class="fas fa-location-dot"></i>
                    <span id="locationBtnText">Detect My Current Location</span>
                </button>
                <div class="location-status" id="locationStatus">
                    <i class="fas fa-info-circle"></i>
                    <span id="locationStatusText">Click to auto-detect your pickup location</span>
                </div>

                <!-- API Status Panel -->
                <div class="api-status" id="apiStatus">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-map-marked-alt" style="color: var(--accent); font-size: 20px;"></i>
                        <div>
                            <div id="apiStatusText">Checking Google Maps API...</div>
                            <div style="font-size: 11px; color: var(--text-sec); margin-top: 4px;" id="apiHelpText"></div>
                        </div>
                    </div>
                </div>

                <div class="search-field">
                    <i class="fas fa-circle"></i>
                    <input type="text" id="homePickup" placeholder="Pickup location" autocomplete="off">
                    <button class="location-action-btn" id="useCurrentAsPickup" title="Use current location as pickup">
                        <i class="fas fa-location-dot"></i>
                    </button>
                </div>
                <div class="results-dropdown" id="homePickupResults"></div>
                
                <div class="search-field">
                    <i class="fas fa-flag"></i>
                    <input type="text" id="homeDest" placeholder="Destination" autocomplete="off">
                </div>
                <div class="results-dropdown" id="homeDestResults"></div>

                <!-- Working Routes -->
                <div style="margin: 15px 0;">
                    <div style="color: var(--accent); font-size: 14px; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> Popular routes:
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="suggestion-chip" onclick="setRoute('Qonce, South Africa', 'East London, South Africa')">Qonce â†’ East London</span>
                        <span class="suggestion-chip" onclick="setRoute('Mthatha, South Africa', 'Port St Johns, South Africa')">Mthatha â†’ Port St Johns</span>
                        <span class="suggestion-chip" onclick="setRoute('Gqeberha, South Africa', 'Jeffreys Bay, South Africa')">Gqeberha â†’ Jeffreys Bay</span>
                    </div>
                </div>

                <!-- Qonce area pills -->
                <div class="area-pills" id="homePills"></div>

                <button class="btn-outline" id="homeAdminBtn" style="width:100%; margin-bottom:16px;">
                    <i class="fas fa-user-shield"></i> Admin
                    <span id="adminNotificationBadge" class="notification-badge" style="display:none;">0</span>
                </button>

                <div class="search-field">
                    <i class="fas fa-clock"></i>
                    <select id="homeTime">
                        <option>Now</option>
                        <option>22:00</option>
                        <option>23:00</option>
                        <option>00:00</option>
                        <option>01:00</option>
                    </select>
                </div>

                <button class="btn-primary" id="homeEstimateBtn" disabled>
                    <i class="fas fa-calculator"></i> Calculate Fare (R60/km)
                </button>

                <div class="fare-card" id="homeFareCard">
                    <div class="fare-amount" id="homeFareAmount">R 0</div>
                    <div id="homeFareDetail" style="margin:12px 0;"></div>
                    <div id="routeInfo" style="font-size:14px; color:var(--text-sec); margin-bottom:16px;"></div>
                    <button class="btn-primary btn-success" id="homeConfirmBtn">Confirm & continue</button>
                </div>
            </div>
            
            <div style="display:flex; align-items:center; justify-content:center; gap:5px; margin-top:10px; font-size:12px; color:var(--text-sec);">
                <span class="connection-status" id="connectionStatus"></span>
                <span id="connectionText">Connecting to Firebase...</span>
            </div>
        </div>
    </div>

    <!-- Other pages (simplified for brevity) -->
    <div id="bookingPage" class="page">
        <div class="header">
            <button class="back-btn" id="bookingBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Confirm booking</div>
        </div>
        <div class="container">
            <div class="search-card">
                <div id="bookingDetails" style="margin-bottom:20px;"></div>
                <button class="btn-primary" id="bookingConfirmBtn"><i class="fas fa-check"></i> Book now</button>
            </div>
        </div>
    </div>

    <div id="ridePage" class="page">
        <div class="header">
            <button class="back-btn" id="rideBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Current ride</div>
        </div>
        <div class="container">
            <div id="currentRideContainer"></div>
            <div class="driver-card" id="rideDriverCard" style="display:none;"></div>
        </div>
    </div>

    <div id="historyPage" class="page">
        <div class="header">
            <button class="back-btn" id="historyBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Your trips</div>
        </div>
        <div class="container">
            <div id="historyList"></div>
            <div id="totalSpent" style="font-weight:700; margin-top:20px;"></div>
        </div>
    </div>

    <div id="profilePage" class="page">
        <div class="header">
            <button class="back-btn" id="profileBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Profile</div>
        </div>
        <div class="container">
            <div class="profile-card" id="profileCard"></div>
            <button class="btn-outline" id="logoutBtn" style="margin-top:20px;">Log out</button>
        </div>
    </div>

    <div id="adminPage" class="page">
        <div class="header">
            <button class="back-btn" id="adminBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Admin control</div>
            <span id="adminPageNotificationBadge" class="notification-badge" style="display:none;">0</span>
        </div>
        <div class="container">
            <div class="search-field">
                <i class="fas fa-lock"></i>
                <input type="password" id="adminCodeInput" placeholder="Admin code">
            </div>
            <button class="btn-primary" id="adminLoginPageBtn">Login</button>
            
            <div id="adminDashboard" style="display:none; margin-top:24px;">
                <div style="background:var(--card); border-radius:24px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <i class="fas fa-bell" style="color:var(--accent); font-size:24px;"></i>
                        <div>
                            <h4 style="margin-bottom:4px;">ðŸ”´ REAL-TIME NOTIFICATIONS ACTIVE</h4>
                            <p style="color:var(--text-sec); font-size:13px;">You'll be notified instantly when customers request rides</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="auth-btn" id="enableNotificationsBtn" style="background:var(--accent);">ðŸ”” Enable Desktop Alerts</button>
                        <button class="auth-btn" id="testNotificationBtn">ðŸ”Š Test Sound</button>
                    </div>
                </div>

                <h4 style="margin-bottom:16px;">Live Ride Requests 
                    <span id="pendingCount" style="background:var(--notification); padding:4px 10px; border-radius:20px; font-size:12px; margin-left:10px;">0</span>
                </h4>
                <div id="adminRideList"></div>
                
                <h4 style="margin:24px 0 16px;">Update ETA</h4>
                <select id="adminEtaSelect" class="search-field">
                    <option>5 min</option>
                    <option>10 min</option>
                    <option>15 min</option>
                    <option>20 min</option>
                </select>
                <button class="btn-primary" id="adminUpdateEta">Update ETA for all rides</button>
                
                <div class="admin-debug-panel">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <strong>ðŸ”¥ Firebase Status</strong>
                        <span id="firebaseStatus" style="color:var(--success);">Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Sign up</h3>
            <div class="selfie-upload">
                <div class="selfie-preview">
                    <img id="regSelfieImg" style="display:none;">
                    <div id="regSelfiePlaceholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:32px;">ðŸ“¸</div>
                </div>
                <button class="btn-outline" id="regUploadBtn" style="margin-bottom:8px;">Upload selfie</button>
                <input type="file" id="regSelfieInput" accept="image/*" capture="user" style="display:none;">
                <div class="text-small" style="color:var(--text-sec);">Selfie required</div>
            </div>
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="regName" placeholder="Full name">
            </div>
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-phone"></i>
                <input id="regPhone" placeholder="Phone number">
            </div>
            <button class="btn-primary" id="regSubmit">Create account</button>
            <button class="btn-outline" id="closeRegisterModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Log in</h3>
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="loginName" placeholder="Full name">
            </div>
            <div class="search-field" style="margin-bottom:20px;">
                <i class="fas fa-phone"></i>
                <input id="loginPhone" placeholder="Phone number">
            </div>
            <button class="btn-primary" id="loginSubmit">Login</button>
            <button class="btn-outline" id="closeLoginModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-page="homePage"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" data-page="ridePage"><i class="fas fa-car"></i><span>Ride</span></div>
        <div class="nav-item" data-page="historyPage"><i class="fas fa-history"></i><span>History</span></div>
        <div class="nav-item" data-page="profilePage"><i class="fas fa-user"></i><span>Profile</span></div>
    </div>
</div>

<script>
// Global function for route selection
function setRoute(pickup, dest) {
    document.getElementById('homePickup').value = pickup;
    document.getElementById('homeDest').value = dest;
    showToast('ðŸ“ Now click "Calculate Fare"', 'success');
}

// Global init function for Google Maps
window.initMap = function() {
    console.log('Google Maps initialized');
    if (window.appInitMap) {
        window.appInitMap();
    }
};

(function() {
    const firebaseConfig = {
        apiKey: "AIzaSyDnBExWhYrsXlpyVJsseCdfYbnNgqiKS6Q",
        authDomain: "nytryder-fbf3e.firebaseapp.com",
        projectId: "nytryder-fbf3e",
        storageBucket: "nytryder-fbf3e.firebasestorage.app",
        messagingSenderId: "566810796737",
        appId: "1:566810796737:web:1a92fca279609eaaefaa40",
        measurementId: "G-53M01XTSJL"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const ridesRef = database.ref('rides');
    const usersRef = database.ref('users');

    let currentUser = null;
    let isAdminLoggedIn = false;
    let pendingNotificationCount = 0;
    let directionsService;
    let geocoder;
    let isCalculating = false;
    let mapsReady = false;
    let currentLatLng = null;
    let currentAddress = '';

    // Initialize Maps
    window.appInitMap = function() {
        try {
            directionsService = new google.maps.DirectionsService();
            geocoder = new google.maps.Geocoder();
            mapsReady = true;
            
            document.getElementById('apiStatus').className = 'api-status success';
            document.getElementById('apiStatusText').innerHTML = 'âœ… Google Maps API ready';
            document.getElementById('apiHelpText').innerHTML = 'Location detection active';
            document.getElementById('homeEstimateBtn').disabled = false;
            
            showToast('âœ… Google Maps ready!', 'success');
        } catch (error) {
            console.error('Map init error:', error);
        }
    };

    if (typeof google !== 'undefined' && google.maps) {
        window.appInitMap();
    }

    // ========== AUTO LOCATION DETECTION ==========
    function detectUserLocation() {
        const locationBtn = document.getElementById('detectLocationBtn');
        const locationBtnText = document.getElementById('locationBtnText');
        const locationStatus = document.getElementById('locationStatusText');
        
        if (!navigator.geolocation) {
            locationStatus.innerHTML = 'âŒ Geolocation not supported by your browser';
            showToast('Geolocation not supported', 'warning');
            return;
        }

        locationBtnText.innerHTML = 'Detecting location...';
        locationBtn.disabled = true;
        locationStatus.innerHTML = 'ðŸ“ Requesting location permission...';

        navigator.geolocation.getCurrentPosition(
            // Success callback
            (position) => {
                currentLatLng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                locationStatus.innerHTML = 'ðŸ“ Converting to address...';

                // Reverse geocode to get address
                geocoder.geocode({ location: currentLatLng }, (results, status) => {
                    locationBtn.disabled = false;
                    locationBtnText.innerHTML = 'âœ“ Location Detected';
                    
                    if (status === 'OK' && results[0]) {
                        currentAddress = results[0].formatted_address;
                        document.getElementById('homePickup').value = currentAddress;
                        locationStatus.innerHTML = `âœ… Location detected: ${currentAddress.substring(0, 50)}...`;
                        showToast('ðŸ“ Location detected!', 'success');
                        
                        // Also try to get nearest town for suggestions
                        getNearestTown(currentLatLng);
                    } else {
                        locationStatus.innerHTML = 'âŒ Could not get address from location';
                        showToast('Location found but address unavailable', 'warning');
                    }
                });
            },
            // Error callback
            (error) => {
                locationBtn.disabled = false;
                locationBtnText.innerHTML = 'âŒ Location Failed - Try Again';
                
                let errorMsg = 'Location error: ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += 'Please allow location access';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += 'Location unavailable';
                        break;
                    case error.TIMEOUT:
                        errorMsg += 'Location request timed out';
                        break;
                    default:
                        errorMsg += 'Unknown error';
                }
                locationStatus.innerHTML = `âŒ ${errorMsg}`;
                showToast(errorMsg, 'warning');
            },
            // Options
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // Get nearest town from coordinates
    function getNearestTown(latLng) {
        // Common Eastern Cape towns for suggestions
        const towns = [
            { name: 'Qonce, South Africa', lat: -32.8769, lng: 27.3917 },
            { name: 'East London, South Africa', lat: -33.0153, lng: 27.9116 },
            { name: 'Mthatha, South Africa', lat: -31.5889, lng: 28.7844 },
            { name: 'Gqeberha, South Africa', lat: -33.9608, lng: 25.6022 },
            { name: 'Bhisho, South Africa', lat: -32.8472, lng: 27.4422 }
        ];

        let nearest = null;
        let minDistance = Infinity;

        towns.forEach(town => {
            const distance = Math.sqrt(
                Math.pow(town.lat - latLng.lat, 2) + 
                Math.pow(town.lng - latLng.lng, 2)
            );
            if (distance < minDistance) {
                minDistance = distance;
                nearest = town.name;
            }
        });

        if (nearest) {
            const statusEl = document.getElementById('locationStatusText');
            statusEl.innerHTML = `ðŸ“ Near: ${nearest.replace(', South Africa', '')}`;
        }
    }

    // Use current location as pickup
    function useCurrentAsPickup() {
        if (currentAddress) {
            document.getElementById('homePickup').value = currentAddress;
            showToast('ðŸ“ Pickup location set', 'success');
        } else {
            detectUserLocation();
        }
    }

    // Connection status
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        const connected = snap.val();
        document.getElementById('connectionStatus').className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
        document.getElementById('connectionText').textContent = connected ? 'âœ… Connected to Firebase' : 'âŒ Disconnected';
        document.getElementById('firebaseStatus').textContent = connected ? 'Connected âœ“' : 'Disconnected';
    });

    // Ride listeners
    ridesRef.limitToLast(1).on('child_added', (snapshot) => {
        const newRide = snapshot.val();
        if (isAdminLoggedIn && newRide && newRide.status === 'pending') {
            playNotificationSound();
            showToast(`ðŸš— NEW RIDE: ${newRide.pickup} â†’ ${newRide.dest} (R${newRide.amount})`, 'warning');
        }
    });

    ridesRef.on('value', (snapshot) => {
        const rides = snapshot.val();
        if (rides) {
            const ridesArray = Object.values(rides);
            pendingNotificationCount = ridesArray.filter(r => r && r.status === 'pending').length;
            updateNotificationBadges();
            
            if (document.getElementById('adminPage').classList.contains('active') && isAdminLoggedIn) {
                renderAdminRides(ridesArray);
            }
        }
    });

    // Fare calculation
    const FARE_PER_KM = 60;

    function calculateFare(pickup, destination, callback) {
        if (!mapsReady) {
            callback({ success: false, error: 'Google Maps not ready. Please wait...' });
            return;
        }

        if (isCalculating) {
            callback({ success: false, error: 'Already calculating...' });
            return;
        }

        isCalculating = true;
        const btn = document.getElementById('homeEstimateBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Calculating... <span class="loader"></span>';
        btn.disabled = true;

        const request = {
            origin: pickup,
            destination: destination,
            travelMode: 'DRIVING',
            region: 'za'
        };

        directionsService.route(request, (result, status) => {
            isCalculating = false;
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (status === 'OK') {
                const distance = result.routes[0].legs[0].distance.value / 1000;
                const duration = result.routes[0].legs[0].duration.text;
                const fare = Math.round(distance * FARE_PER_KM);
                
                callback({
                    success: true,
                    distance: Math.round(distance * 10) / 10,
                    duration: duration,
                    fare: fare
                });
            } else {
                let errorMsg = 'Could not calculate route. ';
                if (status === 'ZERO_RESULTS') {
                    errorMsg = 'No route found between these locations.';
                } else if (status === 'NOT_FOUND') {
                    errorMsg = 'One or both locations not found.';
                } else {
                    errorMsg = `Error: ${status}. Check API setup.`;
                }
                callback({ success: false, error: errorMsg });
            }
        });
    }

    // Event listeners
    document.getElementById('detectLocationBtn').onclick = detectUserLocation;
    document.getElementById('useCurrentAsPickup').onclick = useCurrentAsPickup;

    document.getElementById('homeEstimateBtn').onclick = () => {
        if (!mapsReady) {
            alert('Google Maps still loading. Please wait...');
            return;
        }

        const p = document.getElementById('homePickup').value.trim();
        const d = document.getElementById('homeDest').value.trim();
        
        if (!p || !d) {
            alert('Please enter pickup and destination');
            return;
        }

        calculateFare(p, d, (result) => {
            if (result.success) {
                document.getElementById('homeFareAmount').innerText = 'R ' + result.fare.toLocaleString();
                document.getElementById('homeFareDetail').innerHTML = `
                    <strong>${p}</strong> <i class="fas fa-arrow-right" style="color:var(--accent);"></i> <strong>${d}</strong>
                `;
                document.getElementById('routeInfo').innerHTML = `
                    <i class="fas fa-road"></i> ${result.distance} km Â· 
                    <i class="fas fa-clock"></i> ${result.duration} Â· 
                    <i class="fas fa-tag"></i> R${FARE_PER_KM}/km
                `;
                document.getElementById('homeFareCard').style.display = 'block';
                
                window.lastEstimate = { 
                    pickup: p, 
                    dest: d, 
                    amount: result.fare, 
                    distance: result.distance, 
                    duration: result.duration 
                };
                
                showToast(`âœ… Fare calculated: R${result.fare.toLocaleString()}`, 'success');
            } else {
                alert(result.error);
            }
        });
    };

    document.getElementById('homeConfirmBtn').onclick = () => {
        if (!window.lastEstimate) return;
        if (!currentUser) {
            document.getElementById('loginModal').classList.add('active');
            return;
        }
        document.getElementById('bookingDetails').innerHTML = `
            <div style="background:var(--card); border-radius:24px; padding:20px;">
                <p style="font-size:18px; margin-bottom:12px;">
                    <strong>${window.lastEstimate.pickup}</strong> 
                    <i class="fas fa-arrow-right" style="color:var(--accent);"></i> 
                    <strong>${window.lastEstimate.dest}</strong>
                </p>
                <p style="font-size:32px; font-weight:700; color:var(--accent);">R${window.lastEstimate.amount.toLocaleString()}</p>
                <p>${window.lastEstimate.distance} km Â· ${window.lastEstimate.duration} Â· R60/km</p>
                <p>Time: ${document.getElementById('homeTime').value}</p>
            </div>
        `;
        showPage('bookingPage');
    };

    document.getElementById('bookingConfirmBtn').onclick = () => {
        if (!currentUser || !window.lastEstimate) return;
        
        const newRide = {
            id: 'r' + Date.now(),
            userId: currentUser.id,
            userName: currentUser.name,
            userPhone: currentUser.phone,
            pickup: window.lastEstimate.pickup,
            dest: window.lastEstimate.dest,
            amount: window.lastEstimate.amount,
            distance: window.lastEstimate.distance,
            duration: window.lastEstimate.duration,
            status: 'pending',
            time: new Date().toLocaleString(),
            driverETA: '12 min',
            ratePerKm: FARE_PER_KM
        };
        
        ridesRef.push(newRide);
        alert('âœ… Ride booked successfully!');
        showPage('homePage');
        document.getElementById('homeFareCard').style.display = 'none';
        window.lastEstimate = null;
    };

    // Utility functions
    function playNotificationSound() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        } catch (e) {}
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast-notification ' + (type === 'warning' ? 'warning' : '');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 4000);
    }

    function updateNotificationBadges() {
        const badges = ['adminNotificationBadge', 'adminPageNotificationBadge', 'pendingCount'];
        badges.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (pendingNotificationCount > 0) {
                    el.style.display = 'inline';
                    el.textContent = pendingNotificationCount;
                } else {
                    el.style.display = 'none';
                }
            }
        });
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const activeNav = Array.from(document.querySelectorAll('.nav-item')).find(n => n.dataset.page === pageId);
        if (activeNav) activeNav.classList.add('active');
        window.scrollTo(0, 0);
    }

    // Back buttons
    document.getElementById('bookingBack').onclick = () => showPage('homePage');
    document.getElementById('rideBack').onclick = () => showPage('homePage');
    document.getElementById('historyBack').onclick = () => showPage('homePage');
    document.getElementById('profileBack').onclick = () => showPage('homePage');
    document.getElementById('adminBack').onclick = () => showPage('homePage');

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const page = item.dataset.page;
            if (['profilePage', 'historyPage', 'ridePage'].includes(page) && !currentUser) {
                alert('Please login first');
                document.getElementById('loginModal').classList.add('active');
                return;
            }
            showPage(page);
        });
    });

    // Modal controls
    document.getElementById('homeLoginBtn').onclick = () => document.getElementById('loginModal').classList.add('active');
    document.getElementById('homeRegisterBtn').onclick = () => document.getElementById('registerModal').classList.add('active');
    document.getElementById('homeAdminBtn').onclick = () => showPage('adminPage');
    
    document.getElementById('closeLoginModal').onclick = () => {
        document.getElementById('loginModal').classList.remove('active');
        document.getElementById('loginName').value = '';
        document.getElementById('loginPhone').value = '';
    };
    
    document.getElementById('closeRegisterModal').onclick = () => {
        document.getElementById('registerModal').classList.remove('active');
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        selfieData = null;
    };

    // Selfie upload
    let selfieData = null;
    document.getElementById('regUploadBtn').onclick = () => document.getElementById('regSelfieInput').click();
    
    document.getElementById('regSelfieInput').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selfieData = ev.target.result;
                document.getElementById('regSelfieImg').src = ev.target.result;
                document.getElementById('regSelfieImg').style.display = 'block';
                document.getElementById('regSelfiePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    };

    // Register
    document.getElementById('regSubmit').onclick = () => {
        const name = document.getElementById('regName').value.trim();
        const phone = document.getElementById('regPhone').value.trim();
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        if (!selfieData) {
            alert('Selfie is required');
            return;
        }
        
        const newUser = { 
            id: 'u' + Date.now(), 
            name: name, 
            phone: phone, 
            selfie: selfieData,
            createdAt: new Date().toISOString()
        };
        
        usersRef.child(newUser.id).set(newUser);
        currentUser = newUser;
        
        updateAuthUI();
        document.getElementById('registerModal').classList.remove('active');
        
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        selfieData = null;
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        
        alert('Registration successful!');
    };

    // Login
    document.getElementById('loginSubmit').onclick = () => {
        const name = document.getElementById('loginName').value.trim();
        const phone = document.getElementById('loginPhone').value.trim();
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        usersRef.once('value', (snapshot) => {
            const users = snapshot.val();
            let foundUser = null;
            
            if (users) {
                for (let id in users) {
                    const u = users[id];
                    if (u && u.name && u.name.toLowerCase() === name.toLowerCase() && u.phone === phone) {
                        foundUser = u;
                        break;
                    }
                }
            }
            
            if (foundUser) {
                currentUser = foundUser;
                updateAuthUI();
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('loginName').value = '';
                document.getElementById('loginPhone').value = '';
                alert('Welcome back, ' + foundUser.name + '!');
            } else {
                alert('No account found. Please register first.');
            }
        });
    };

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
        currentUser = null;
        updateAuthUI();
        showPage('homePage');
        alert('Logged out');
    };

    // Update Auth UI
    function updateAuthUI() {
        const homeAuthBtns = document.getElementById('homeAuthBtns');
        const homeProfile = document.getElementById('homeUserProfile');
        const homeName = document.getElementById('homeUserName');
        const homeAvatarImg = document.getElementById('homeAvatarImg');
        const homeInitials = document.getElementById('homeAvatarInitials');

        if (currentUser) {
            homeAuthBtns.style.display = 'none';
            homeProfile.style.display = 'flex';
            homeName.innerText = currentUser.name.split(' ')[0];
            
            if (currentUser.selfie) {
                homeAvatarImg.src = currentUser.selfie;
                homeAvatarImg.style.display = 'block';
                homeInitials.style.display = 'none';
            } else {
                homeAvatarImg.style.display = 'none';
                homeInitials.style.display = 'flex';
                homeInitials.innerText = currentUser.name.charAt(0);
            }
        } else {
            homeAuthBtns.style.display = 'flex';
            homeProfile.style.display = 'none';
        }
    }

    // Admin functions
    document.getElementById('enableNotificationsBtn').onclick = () => {
        Notification.requestPermission();
    };

    document.getElementById('testNotificationBtn').onclick = () => {
        playNotificationSound();
        showToast('ðŸ”Š Test notification', 'success');
    };

    document.getElementById('adminLoginPageBtn').onclick = () => {
        if (document.getElementById('adminCodeInput').value === '548755') {
            isAdminLoggedIn = true;
            document.getElementById('adminDashboard').style.display = 'block';
            showToast('ðŸ‘‹ Welcome Admin!');
        } else {
            alert('Invalid admin code');
        }
    };

    function renderAdminRides(ridesArray) {
        const pending = ridesArray.filter(r => r && r.status === 'pending');
        const list = document.getElementById('adminRideList');
        
        if (pending.length) {
            list.innerHTML = pending.map(r => `
                <div class="ride-item" style="margin-bottom:16px; border-left: 4px solid var(--notification);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong>${r.pickup} â†’ ${r.dest}</strong>
                        <span style="background:var(--notification); padding:4px 8px; border-radius:20px; font-size:11px;">LIVE</span>
                    </div>
                    <p style="font-size:24px; font-weight:700; color:var(--accent);">R${r.amount}</p>
                    <p style="color:var(--text-sec);">ðŸ‘¤ ${r.userName} Â· ðŸ“± ${r.userPhone}</p>
                    <p style="color:var(--text-sec);">ðŸ“ ${r.distance} km Â· â±ï¸ ${r.duration}</p>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="auth-btn" style="background:green; flex:1;" onclick="acceptRide('${r.id}')">âœ… Accept</button>
                        <button class="auth-btn" style="background:red; flex:1;" onclick="declineRide('${r.id}')">âŒ Decline</button>
                    </div>
                </div>
            `).join('');
        } else {
            list.innerHTML = '<div class="ride-item" style="text-align:center; padding:30px;">No pending rides</div>';
        }
    }

    window.acceptRide = (rideId) => {
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            for (let key in rides) {
                if (rides[key] && rides[key].id === rideId) {
                    rides[key].status = 'accepted';
                    rides[key].driverETA = document.getElementById('adminEtaSelect').value;
                    ridesRef.child(key).set(rides[key]);
                    showToast('âœ… Ride accepted');
                    break;
                }
            }
        });
    };

    window.declineRide = (rideId) => {
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            for (let key in rides) {
                if (rides[key] && rides[key].id === rideId) {
                    ridesRef.child(key).remove();
                    showToast('âŒ Ride declined', 'warning');
                    break;
                }
            }
        });
    };

    document.getElementById('adminUpdateEta').onclick = () => {
        const eta = document.getElementById('adminEtaSelect').value;
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            for (let key in rides) {
                if (rides[key] && rides[key].status === 'accepted') {
                    rides[key].driverETA = eta;
                    ridesRef.child(key).set(rides[key]);
                }
            }
            alert(`ETA updated to ${eta}`);
        });
    };

    // Initialize
    updateAuthUI();

    // Qonce area pills
    const qoncePills = [
        "Qonce, South Africa", 
        "Zwelitsha, South Africa", 
        "Bhisho, South Africa", 
        "Mdantsane, South Africa", 
        "Berlin, South Africa", 
        "Stutterheim, South Africa", 
        "East London, South Africa", 
        "Mthatha, South Africa"
    ];
    const pillDiv = document.getElementById('homePills');
    qoncePills.forEach(place => {
        const p = document.createElement('span');
        p.className = 'pill';
        const displayName = place.replace(', South Africa', '');
        p.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${displayName}`;
        p.onclick = () => {
            if (!document.getElementById('homePickup').value) {
                document.getElementById('homePickup').value = place;
            } else if (!document.getElementById('homeDest').value) {
                document.getElementById('homeDest').value = place;
            }
            showToast(`ðŸ“ ${displayName} added`, 'success');
        };
        pillDiv.appendChild(p);
    });
})();
</script>
</body>
</html>
