<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Nyt Ryder ¬∑ Eastern Cape (Real Google Maps Fares)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=places"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0a0e1a;
            --surface: #141e2c;
            --card: #1f2a3c;
            --accent: #7c4dff;
            --accent2: #9b7aff;
            --text: #ffffff;
            --text-sec: #b1bddb;
            --border: #2c3850;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --notification: #ff4757;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text);
            font-size: 15px;
            overflow-x: hidden;
        }
        .app {
            position: relative;
            width: 100%;
            min-height: 100vh;
        }
        .page {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding-bottom: 90px;
            animation: fadeIn 0.3s ease;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .header {
            background: var(--surface);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .back-btn {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); }
        .header-title {
            font-weight: 700;
            font-size: 20px;
            flex: 1;
        }
        .logo {
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(145deg, var(--accent), #a27cff);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800;
        }
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        .logo-brand {
            font-weight: 800;
            font-size: 18px;
            line-height: 1.2;
        }
        .logo-slogan {
            font-size: 10px;
            font-weight: 500;
            color: var(--accent2);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .auth-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
        }
        .auth-buttons { display: flex; gap: 8px; }
        .auth-btn {
            padding: 10px 18px; border-radius: 40px; font-weight: 600;
            border: 1.5px solid var(--border); background: transparent; color: white;
            cursor: pointer;
        }
        .auth-btn.register { background: var(--accent); border-color: var(--accent); }
        .user-profile {
            display: flex; align-items: center; gap: 8px; background: var(--card);
            padding: 6px 16px 6px 8px; border-radius: 50px;
        }
        .avatar { width: 38px; height: 38px; border-radius: 38px; background: var(--accent); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .container { padding: 18px; }

        .search-card {
            background: var(--surface);
            border-radius: 32px;
            padding: 22px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-field {
            background: var(--card);
            border-radius: 60px;
            padding: 6px 18px 6px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .search-field i { color: var(--accent); font-size: 18px; }
        .search-field input, .search-field select {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            padding: 16px 0;
            width: 100%;
            outline: none;
        }
        .results-dropdown {
            max-height: 250px;
            overflow-y: auto;
            background: var(--card);
            border-radius: 28px;
            margin: 4px 0 16px;
            display: none;
            border: 1px solid var(--border);
        }
        .results-dropdown div {
            padding: 16px 22px;
            border-bottom: 1px solid #2f3a4f;
            font-weight: 500;
            cursor: pointer;
        }
        .results-dropdown div:hover { background: rgba(124,77,255,0.2); }
        .results-dropdown div i { margin-right: 12px; color: var(--accent); }

        .area-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 24px;
        }
        .pill {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .pill i { color: var(--accent); margin-right: 6px; }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            border: none;
            border-radius: 60px;
            padding: 18px;
            font-weight: 700;
            font-size: 18px;
            color: white;
            box-shadow: 0 12px 30px rgba(124,77,255,0.4);
            margin-top: 16px;
            cursor: pointer;
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); }

        .fare-card {
            background: #1b253b;
            border-radius: 40px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .fare-amount { font-size: 42px; font-weight: 800; }

        .driver-card {
            background: linear-gradient(145deg, #1f2c41, #17212f);
            border-radius: 32px;
            padding: 24px;
            margin-top: 30px;
            border: 1px solid #3a4865;
        }
        .driver-selfie {
            width: 90px; height: 90px;
            border-radius: 90px;
            border: 4px solid var(--accent);
            overflow: hidden;
        }
        .driver-selfie img { width:100%; height:100%; object-fit: cover; }
        .contact-row {
            display: flex; gap: 16px; margin-top: 16px; justify-content: center;
            flex-wrap: wrap;
        }
        .contact-phone {
            background: #2a364f; padding: 14px 24px; border-radius: 50px; font-weight: 600;
        }

        .history-item, .ride-item, .profile-card {
            background: var(--card);
            border-radius: 24px;
            padding: 18px;
            margin-bottom: 12px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 18px;
            border-top: 1px solid var(--border);
            z-index: 99;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sec); cursor: pointer;
        }
        .nav-item.active { color: var(--accent); }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96); display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 16px;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card {
            background: var(--surface); border-radius: 48px; padding: 28px 22px;
            width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        .selfie-upload {
            background: var(--card); border: 2px dashed var(--accent); border-radius: 40px; padding: 20px; text-align: center;
            margin-bottom: 20px;
        }
        .selfie-preview {
            width: 120px; height: 120px; border-radius: 120px; margin: 0 auto 16px;
            background: #1a253f; overflow: hidden; border: 4px solid var(--accent);
        }
        .selfie-preview img { width:100%; height:100%; object-fit: cover; }
        
        /* Admin debug panel */
        .admin-debug-panel {
            background: #1e1e2e;
            border-radius: 16px;
            padding: 12px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #a0a0a0;
            border: 1px solid #333;
        }
        .test-btn {
            background: #2a2a3a;
            border: 1px solid #444;
            color: #aaa;
            padding: 8px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
        }
        
        /* Notification badge */
        .notification-badge {
            background: var(--notification);
            color: white;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #ff6b81; }
            100% { transform: scale(1); }
        }
        
        /* Toast notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification.warning {
            background: var(--notification);
        }

        /* Connection status */
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 10px;
            margin-right: 5px;
        }
        .connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .disconnected { background: var(--danger); }

        .loader {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Toast notification container -->
    <div id="toast" class="toast-notification"></div>

<div class="app">

    <!-- ========== HOME PAGE ========== -->
    <div id="homePage" class="page active">
        <div class="auth-row">
            <div class="logo">
                <div class="logo-icon">NR</div>
                <div class="logo-text">
                    <div class="logo-brand">Nyt Ryder</div>
                    <div class="logo-slogan">Ride the Eastern Cape</div>
                </div>
            </div>
            <div id="homeAuth">
                <div class="auth-buttons" id="homeAuthBtns">
                    <button class="auth-btn" id="homeLoginBtn">Log in</button>
                    <button class="auth-btn register" id="homeRegisterBtn">Sign up</button>
                </div>
                <div class="user-profile" id="homeUserProfile" style="display:none;">
                    <div class="avatar" id="homeAvatar">
                        <img id="homeAvatarImg" style="display:none;">
                        <div id="homeAvatarInitials">JD</div>
                    </div>
                    <span id="homeUserName">User</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="search-card">
                <div class="search-field">
                    <i class="fas fa-circle"></i>
                    <input type="text" id="homePickup" placeholder="Pickup (e.g., Qonce CBD)" autocomplete="off">
                </div>
                <div class="results-dropdown" id="homePickupResults"></div>
                
                <div class="search-field">
                    <i class="fas fa-flag"></i>
                    <input type="text" id="homeDest" placeholder="Destination" autocomplete="off">
                </div>
                <div class="results-dropdown" id="homeDestResults"></div>

                <!-- Qonce area pills -->
                <div class="area-pills" id="homePills"></div>

                <!-- Admin login button below pills -->
                <button class="btn-outline" id="homeAdminBtn" style="width:100%; margin-bottom:16px;">
                    <i class="fas fa-user-shield"></i> Admin
                    <span id="adminNotificationBadge" class="notification-badge" style="display:none;">0</span>
                </button>

                <div class="search-field">
                    <i class="fas fa-clock"></i>
                    <select id="homeTime">
                        <option>Now</option>
                        <option>22:00</option>
                        <option>23:00</option>
                        <option>00:00</option>
                        <option>01:00</option>
                    </select>
                </div>

                <button class="btn-primary" id="homeEstimateBtn">
                    <i class="fas fa-calculator"></i> Calculate Real Fare
                </button>

                <div class="fare-card" id="homeFareCard">
                    <div class="fare-amount" id="homeFareAmount">R 0</div>
                    <div id="homeFareDetail" style="margin:12px 0;"></div>
                    <div id="routeInfo" style="font-size:14px; color:var(--text-sec); margin-bottom:16px;"></div>
                    <button class="btn-primary btn-success" id="homeConfirmBtn">Confirm & continue</button>
                </div>
            </div>
            
            <!-- Connection status -->
            <div style="display:flex; align-items:center; justify-content:center; gap:5px; margin-top:10px; font-size:12px; color:var(--text-sec);">
                <span class="connection-status" id="connectionStatus"></span>
                <span id="connectionText">Connecting to Firebase...</span>
            </div>
        </div>
    </div>

    <!-- ========== BOOKING PAGE ========== -->
    <div id="bookingPage" class="page">
        <div class="header">
            <button class="back-btn" id="bookingBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Confirm booking</div>
        </div>
        <div class="container">
            <div class="search-card">
                <div id="bookingDetails" style="margin-bottom:20px;"></div>
                <button class="btn-primary" id="bookingConfirmBtn"><i class="fas fa-check"></i> Book now</button>
            </div>
        </div>
    </div>

    <!-- ========== RIDE PAGE (current ride) ========== -->
    <div id="ridePage" class="page">
        <div class="header">
            <button class="back-btn" id="rideBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Current ride</div>
        </div>
        <div class="container">
            <div id="currentRideContainer"></div>
            <div class="driver-card" id="rideDriverCard" style="display:none;"></div>
        </div>
    </div>

    <!-- ========== HISTORY PAGE ========== -->
    <div id="historyPage" class="page">
        <div class="header">
            <button class="back-btn" id="historyBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Your trips</div>
        </div>
        <div class="container">
            <div id="historyList"></div>
            <div id="totalSpent" style="font-weight:700; margin-top:20px;"></div>
        </div>
    </div>

    <!-- ========== PROFILE PAGE ========== -->
    <div id="profilePage" class="page">
        <div class="header">
            <button class="back-btn" id="profileBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Profile</div>
        </div>
        <div class="container">
            <div class="profile-card" id="profileCard"></div>
            <button class="btn-outline" id="logoutBtn" style="margin-top:20px;">Log out</button>
        </div>
    </div>

    <!-- ========== ADMIN PAGE ========== -->
    <div id="adminPage" class="page">
        <div class="header">
            <button class="back-btn" id="adminBack"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Admin control</div>
            <span id="adminPageNotificationBadge" class="notification-badge" style="display:none;">0</span>
        </div>
        <div class="container">
            <div class="search-field">
                <i class="fas fa-lock"></i>
                <input type="password" id="adminCodeInput" placeholder="Admin code">
            </div>
            <button class="btn-primary" id="adminLoginPageBtn">Login</button>
            
            <div id="adminDashboard" style="display:none; margin-top:24px;">
                <!-- Real-time notification status -->
                <div style="background:var(--card); border-radius:24px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <i class="fas fa-bell" style="color:var(--accent); font-size:24px;"></i>
                        <div>
                            <h4 style="margin-bottom:4px;">üî¥ REAL-TIME NOTIFICATIONS ACTIVE</h4>
                            <p style="color:var(--text-sec); font-size:13px;">You'll be notified instantly when customers request rides</p>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="auth-btn" id="enableNotificationsBtn" style="background:var(--accent);">üîî Enable Desktop Alerts</button>
                        <button class="auth-btn" id="testNotificationBtn">üîä Test Sound</button>
                    </div>
                </div>

                <h4 style="margin-bottom:16px;">Live Ride Requests 
                    <span id="pendingCount" style="background:var(--notification); padding:4px 10px; border-radius:20px; font-size:12px; margin-left:10px;">0</span>
                </h4>
                <div id="adminRideList"></div>
                
                <h4 style="margin:24px 0 16px;">Update ETA</h4>
                <select id="adminEtaSelect" class="search-field">
                    <option>5 min</option>
                    <option>10 min</option>
                    <option>15 min</option>
                    <option>20 min</option>
                </select>
                <button class="btn-primary" id="adminUpdateEta">Update ETA for all rides</button>
                
                <!-- Firebase status -->
                <div class="admin-debug-panel">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <strong>üî• Firebase Status</strong>
                        <span id="firebaseStatus" style="color:var(--success);">Connected</span>
                    </div>
                    <div style="margin-top:12px;">
                        <button class="test-btn" id="testFirebaseBtn">üìù Test Firebase</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== REGISTER MODAL ========== -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Sign up</h3>
            <div class="selfie-upload">
                <div class="selfie-preview">
                    <img id="regSelfieImg" style="display:none;">
                    <div id="regSelfiePlaceholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:32px;">üì∏</div>
                </div>
                <button class="btn-outline" id="regUploadBtn" style="margin-bottom:8px;">Upload selfie</button>
                <input type="file" id="regSelfieInput" accept="image/*" capture="user" style="display:none;">
                <div class="text-small" style="color:var(--text-sec);">Selfie required</div>
            </div>

            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="regName" placeholder="Full name">
            </div>
            
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-phone"></i>
                <input id="regPhone" placeholder="Phone number (e.g., 0767094033)">
            </div>

            <button class="btn-primary" id="regSubmit">Create account</button>
            <button class="btn-outline" id="closeRegisterModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <!-- ========== LOGIN MODAL ========== -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">Log in</h3>
            
            <div class="search-field" style="margin-bottom:12px;">
                <i class="fas fa-user"></i>
                <input id="loginName" placeholder="Full name">
            </div>
            
            <div class="search-field" style="margin-bottom:20px;">
                <i class="fas fa-phone"></i>
                <input id="loginPhone" placeholder="Phone number">
            </div>

            <button class="btn-primary" id="loginSubmit">Login</button>
            <button class="btn-outline" id="closeLoginModal" style="margin-top:12px;">Cancel</button>
        </div>
    </div>

    <!-- bottom navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-page="homePage"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" data-page="ridePage"><i class="fas fa-car"></i><span>Ride</span></div>
        <div class="nav-item" data-page="historyPage"><i class="fas fa-history"></i><span>History</span></div>
        <div class="nav-item" data-page="profilePage"><i class="fas fa-user"></i><span>Profile</span></div>
    </div>
</div>

<script>
(function() {
    // ========== YOUR FIREBASE CONFIG ==========
    const firebaseConfig = {
        apiKey: "AIzaSyDnBExWhYrsXlpyVJsseCdfYbnNgqiKS6Q",
        authDomain: "nytryder-fbf3e.firebaseapp.com",
        projectId: "nytryder-fbf3e",
        storageBucket: "nytryder-fbf3e.firebasestorage.app",
        messagingSenderId: "566810796737",
        appId: "1:566810796737:web:1a92fca279609eaaefaa40",
        measurementId: "G-53M01XTSJL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // References to Firebase locations
    const ridesRef = database.ref('rides');
    const usersRef = database.ref('users');

    // ========== APP STATE ==========
    let currentUser = null;
    let isAdminLoggedIn = false;
    let pendingNotificationCount = 0;
    let directionsService;
    let geocoder;

    // Initialize Google Maps services
    function initMaps() {
        directionsService = new google.maps.DirectionsService();
        geocoder = new google.maps.Geocoder();
        console.log('Google Maps initialized');
    }

    // ========== CONNECTION STATUS ==========
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        const connected = snap.val();
        const statusDot = document.getElementById('connectionStatus');
        const statusText = document.getElementById('connectionText');
        
        if (connected) {
            statusDot.className = 'connection-status connected';
            statusText.textContent = '‚úÖ Connected to Firebase';
            document.getElementById('firebaseStatus').textContent = 'Connected ‚úì';
        } else {
            statusDot.className = 'connection-status disconnected';
            statusText.textContent = '‚ùå Disconnected - Check internet';
            document.getElementById('firebaseStatus').textContent = 'Disconnected';
        }
    });

    // ========== REAL-TIME RIDE LISTENER ==========
    ridesRef.limitToLast(1).on('child_added', (snapshot) => {
        const newRide = snapshot.val();
        
        if (isAdminLoggedIn && newRide.status === 'pending') {
            playNotificationSound();
            showToast(`üöó NEW RIDE: ${newRide.pickup} ‚Üí ${newRide.dest} (R${newRide.amount})`, 'warning');
            showDesktopNotification(
                'üî• New Ride Request!', 
                `From: ${newRide.pickup}\nTo: ${newRide.dest}\nFare: R${newRide.amount}\nCustomer: ${newRide.userName}`
            );
            updateNotificationBadges();
        }
    });

    ridesRef.on('value', (snapshot) => {
        const rides = snapshot.val();
        if (rides) {
            const ridesArray = Object.values(rides);
            const pendingCount = ridesArray.filter(r => r.status === 'pending').length;
            pendingNotificationCount = pendingCount;
            updateNotificationBadges();
            
            if (document.getElementById('adminPage').classList.contains('active') && isAdminLoggedIn) {
                renderAdminRides(ridesArray);
            }
        } else {
            pendingNotificationCount = 0;
            updateNotificationBadges();
            if (document.getElementById('adminPage').classList.contains('active') && isAdminLoggedIn) {
                document.getElementById('adminRideList').innerHTML = '<div class="ride-item" style="text-align:center; padding:30px;">No ride requests yet</div>';
            }
        }
    });

    // ========== GOOGLE MAPS DISTANCE CALCULATION ==========
    const FARE_PER_KM = 15; // R15 per kilometer

    function calculateRealFare(pickup, destination, callback) {
        const btn = document.getElementById('homeEstimateBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Calculating... <span class="loader"></span>';
        btn.disabled = true;

        // First, geocode the addresses to get coordinates
        Promise.all([
            geocodeAddress(pickup),
            geocodeAddress(destination)
        ]).then(([origin, dest]) => {
            // Use Directions Service to get driving distance
            const request = {
                origin: origin,
                destination: dest,
                travelMode: 'DRIVING'
            };

            directionsService.route(request, (result, status) => {
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (status === 'OK') {
                    const distance = result.routes[0].legs[0].distance.value / 1000; // Convert to km
                    const duration = result.routes[0].legs[0].duration.text;
                    const fare = Math.round(distance * FARE_PER_KM);
                    
                    callback({
                        success: true,
                        distance: Math.round(distance * 10) / 10,
                        duration: duration,
                        fare: fare,
                        route: result.routes[0].legs[0]
                    });
                } else {
                    callback({
                        success: false,
                        error: 'Could not calculate distance. Please check addresses.'
                    });
                }
            });
        }).catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            callback({
                success: false,
                error: 'Could not find one of the addresses. Please be more specific.'
            });
        });
    }

    function geocodeAddress(address) {
        return new Promise((resolve, reject) => {
            // Add "Eastern Cape, South Africa" to improve results
            const fullAddress = `${address}, Eastern Cape, South Africa`;
            
            geocoder.geocode({ address: fullAddress }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    resolve(results[0].geometry.location);
                } else {
                    reject(status);
                }
            });
        });
    }

    // ========== NOTIFICATION FUNCTIONS ==========
    function playNotificationSound() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
            
            setTimeout(() => {
                const oscillator2 = audioCtx.createOscillator();
                const gainNode2 = audioCtx.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioCtx.destination);
                oscillator2.frequency.setValueAtTime(1000, audioCtx.currentTime);
                gainNode2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                oscillator2.start();
                oscillator2.stop(audioCtx.currentTime + 0.2);
            }, 300);
        } catch (e) {
            console.log('Audio not supported');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast-notification ' + (type === 'warning' ? 'warning' : '');
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 4000);
    }

    function showDesktopNotification(title, body) {
        if (!("Notification" in window)) return;
        
        if (Notification.permission === "granted") {
            new Notification(title, { 
                body: body,
                icon: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'45\' fill=\'%237c4dff\'/%3E%3Ctext x=\'50\' y=\'70\' font-size=\'50\' text-anchor=\'middle\' fill=\'white\'%3ENR%3C/text%3E%3C/svg%3E'
            });
        }
    }

    function updateNotificationBadges() {
        const adminBadge = document.getElementById('adminNotificationBadge');
        const adminPageBadge = document.getElementById('adminPageNotificationBadge');
        const pendingCountSpan = document.getElementById('pendingCount');
        
        if (pendingNotificationCount > 0) {
            adminBadge.style.display = 'inline';
            adminBadge.textContent = pendingNotificationCount;
            adminPageBadge.style.display = 'inline';
            adminPageBadge.textContent = pendingNotificationCount;
            if (pendingCountSpan) pendingCountSpan.textContent = pendingNotificationCount;
        } else {
            adminBadge.style.display = 'none';
            adminPageBadge.style.display = 'none';
            if (pendingCountSpan) pendingCountSpan.textContent = '0';
        }
    }

    // ========== EASTERN CAPE LOCATIONS ==========
    const ecPlaces = [
        "Qonce CBD", "Qonce (King William's Town)", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim",
        "Keiskammahoek", "Dimbaza", "Alice", "Fort Beaufort", "Adelaide", "Bedford", "Cradock", "Tarkastad",
        "Queenstown", "Cofimvaba", "Dutywa", "Butterworth", "Idutywa", "Mthatha", "Libode", "Ngqeleni",
        "Port St Johns", "Lusikisiki", "Flagstaff", "Mount Ayliff", "Mount Frere", "Kokstad", "Matatiele",
        "Mount Fletcher", "Maclear", "Elliot", "Ugie", "Calcutta", "Gonubie", "East London", "Cambridge",
        "Amalinda", "Nahoon", "Beacon Bay", "Vincent", "Duncan Village", "KwaNobuhle", "KwaDwesi",
        "KwaZakhele", "Motherwell", "Uitenhage", "Despatch", "Gqeberha", "Walmer", "Summerstrand",
        "Humansdorp", "Jeffreys Bay", "St Francis Bay", "Cape St Francis", "Patensie", "Hankey",
        "Kirkwood", "Addo", "Colchester", "Graaff-Reinet", "Nieu-Bethesda", "Aberdeen", "Jansenville",
        "Willowmore", "Steytlerville", "Uniondale", "Klipplaat", "Murraysburg", "Richmond",
        "Middelburg EC", "Noupoort", "Colesberg", "Venterstad", "Burgersdorp", "Aliwal North",
        "Lady Grey", "Barkly East", "Rhodes", "Dordrecht", "Indwe", "Molteno", "Sterkstroom",
        "Hofmeyr", "Somerset East", "Cookhouse", "Pearston"
    ];
    const allEC = [...new Set(ecPlaces)].sort();

    // Qonce area pills
    const qoncePills = ["Qonce CBD", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim", "Keiskammahoek", "Dimbaza", "East London", "Mthatha"];
    const pillDiv = document.getElementById('homePills');
    qoncePills.forEach(place => {
        let p = document.createElement('span');
        p.className = 'pill';
        p.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${place}`;
        p.onclick = () => {
            if (!document.getElementById('homePickup').value) {
                document.getElementById('homePickup').value = place;
            } else if (!document.getElementById('homeDest').value) {
                document.getElementById('homeDest').value = place;
            }
        };
        pillDiv.appendChild(p);
    });

    const DRIVER = {
        name: "Mziwovuyo Mei",
        phone1: "076 709 4033",
        phone2: "043 065 0097",
        car: "Ford Fiesta White",
        plate: "DCW 449 NC",
        selfie: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2325384d'/%3E%3Ccircle cx='50' cy='30' r='16' fill='%233d556b'/%3E%3Ccircle cx='35' cy='24' r='4' fill='%23fff'/%3E%3Ccircle cx='65' cy='24' r='4' fill='%23fff'/%3E%3Cpath d='M38 44 Q50 58,62 44' stroke='%23fff' stroke-width='5' fill='none'/%3E%3C/svg%3E"
    };

    // ========== PAGE ROUTER ==========
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        let activeNav = Array.from(document.querySelectorAll('.nav-item')).find(n => n.dataset.page === pageId);
        if (activeNav) activeNav.classList.add('active');
        
        window.scrollTo(0, 0);
        
        if (pageId === 'historyPage' && currentUser) loadHistory();
        if (pageId === 'profilePage' && currentUser) loadProfile();
        if (pageId === 'ridePage') loadCurrentRide();
    }

    // Back buttons
    document.getElementById('bookingBack').onclick = () => showPage('homePage');
    document.getElementById('rideBack').onclick = () => showPage('homePage');
    document.getElementById('historyBack').onclick = () => showPage('homePage');
    document.getElementById('profileBack').onclick = () => showPage('homePage');
    document.getElementById('adminBack').onclick = () => showPage('homePage');

    // Bottom navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            let page = item.dataset.page;
            if (page === 'profilePage' || page === 'historyPage' || page === 'ridePage') {
                if (!currentUser) {
                    alert('Please login first');
                    document.getElementById('loginModal').classList.add('active');
                    return;
                }
            }
            showPage(page);
        });
    });

    // ========== LOCATION SEARCH ==========
    function filterPlaces(query) { 
        if (!query) return []; 
        return allEC.filter(p => p.toLowerCase().includes(query.toLowerCase())).slice(0, 12); 
    }

    const pickup = document.getElementById('homePickup');
    const dest = document.getElementById('homeDest');
    const pickupRes = document.getElementById('homePickupResults');
    const destRes = document.getElementById('homeDestResults');

    function setupSearch(input, res) {
        input.addEventListener('input', () => {
            let matches = filterPlaces(input.value);
            if (matches.length) {
                res.innerHTML = matches.map(p => `<div><i class="fas fa-location-dot"></i> ${p}</div>`).join('');
                res.style.display = 'block';
                Array.from(res.children).forEach(div => {
                    div.onclick = () => { 
                        input.value = div.innerText.trim(); 
                        res.style.display = 'none'; 
                    };
                });
            } else {
                res.style.display = 'none';
            }
        });
        
        document.addEventListener('click', (e) => { 
            if (!res.contains(e.target) && e.target !== input) {
                res.style.display = 'none'; 
            }
        });
    }
    setupSearch(pickup, pickupRes);
    setupSearch(dest, destRes);

    // ========== FARE CALCULATION WITH GOOGLE MAPS ==========
    let lastEstimate = null;

    document.getElementById('homeEstimateBtn').onclick = () => {
        let p = pickup.value.trim();
        let d = dest.value.trim();
        
        if (!p || !d) { 
            alert('Please enter pickup and destination'); 
            return; 
        }

        calculateRealFare(p, d, (result) => {
            if (result.success) {
                document.getElementById('homeFareAmount').innerText = 'R ' + result.fare;
                document.getElementById('homeFareDetail').innerHTML = `
                    <strong>${p}</strong> <i class="fas fa-arrow-right" style="color:var(--accent);"></i> <strong>${d}</strong>
                `;
                document.getElementById('routeInfo').innerHTML = `
                    <i class="fas fa-road"></i> ${result.distance} km ¬∑ 
                    <i class="fas fa-clock"></i> ${result.duration} ¬∑ 
                    <i class="fas fa-coins"></i> R${FARE_PER_KM}/km
                `;
                document.getElementById('homeFareCard').style.display = 'block';
                
                lastEstimate = { 
                    pickup: p, 
                    dest: d, 
                    amount: result.fare, 
                    distance: result.distance,
                    duration: result.duration
                };
            } else {
                alert(result.error || 'Could not calculate fare. Please try again.');
            }
        });
    };

    document.getElementById('homeConfirmBtn').onclick = () => {
        if (!lastEstimate) return;
        if (!currentUser) {
            document.getElementById('loginModal').classList.add('active');
            return;
        }
        document.getElementById('bookingDetails').innerHTML = `
            <div style="background:var(--card); border-radius:24px; padding:20px;">
                <p style="font-size:18px; margin-bottom:12px;"><strong>${lastEstimate.pickup}</strong> <i class="fas fa-arrow-right" style="color:var(--accent);"></i> <strong>${lastEstimate.dest}</strong></p>
                <p style="font-size:24px; font-weight:700; color:var(--accent);">R${lastEstimate.amount}</p>
                <p>Distance: ${lastEstimate.distance} km</p>
                <p>Travel time: ${lastEstimate.duration}</p>
                <p>Time: ${document.getElementById('homeTime').value}</p>
            </div>
        `;
        showPage('bookingPage');
    };

    document.getElementById('bookingConfirmBtn').onclick = () => {
        if (!currentUser || !lastEstimate) return;
        
        let newRide = {
            id: 'r' + Date.now(),
            userId: currentUser.id,
            userName: currentUser.name,
            userPhone: currentUser.phone,
            pickup: lastEstimate.pickup,
            dest: lastEstimate.dest,
            amount: lastEstimate.amount,
            distance: lastEstimate.distance,
            duration: lastEstimate.duration,
            status: 'pending',
            time: new Date().toLocaleString(),
            driverETA: '12 min'
        };
        
        // Save to Firebase
        ridesRef.push(newRide);
        
        alert('‚úÖ Ride booked successfully! Admin has been notified in real-time.');
        
        showPage('homePage');
        document.getElementById('homeFareCard').style.display = 'none';
    };

    // ========== CURRENT RIDE ==========
    function loadCurrentRide() {
        if (!currentUser) return;
        
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                let active = ridesArray.filter(r => r.userId === currentUser.id && (r.status === 'pending' || r.status === 'accepted'));
                let container = document.getElementById('currentRideContainer');
                
                if (active.length) {
                    let r = active[0];
                    container.innerHTML = `
                        <div class="ride-item">
                            <p style="font-size:18px; margin-bottom:8px;"><strong>${r.pickup} ‚Üí ${r.dest}</strong></p>
                            <p style="color:var(--text-sec);">Fare: R${r.amount} | Status: <span style="color:${r.status === 'accepted' ? 'var(--success)' : 'var(--warning)'};">${r.status}</span></p>
                            <p style="color:var(--text-sec);">Distance: ${r.distance} km | Duration: ${r.duration}</p>
                            <p style="color:var(--text-sec);">Driver ETA: <span id="liveEta" style="color:white; font-weight:700;">${r.driverETA}</span></p>
                        </div>
                    `;
                    
                    document.getElementById('rideDriverCard').style.display = 'block';
                    document.getElementById('rideDriverCard').innerHTML = `
                        <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
                            <div class="driver-selfie"><img src="${DRIVER.selfie}"></div>
                            <div>
                                <div style="font-size:20px; font-weight:700;">${DRIVER.name}</div>
                                <div style="color:var(--text-sec);">${DRIVER.car}</div>
                                <div style="font-family:monospace; font-size:18px; margin-top:4px;">${DRIVER.plate}</div>
                            </div>
                        </div>
                        <div class="contact-row">
                            <div class="contact-phone"><i class="fas fa-phone-alt"></i> ${DRIVER.phone1}</div>
                            <div class="contact-phone"><i class="fas fa-phone-alt"></i> ${DRIVER.phone2}</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="ride-item">No active ride</div>';
                    document.getElementById('rideDriverCard').style.display = 'none';
                }
            }
        });
    }

    // ========== HISTORY ==========
    function loadHistory() {
        if (!currentUser) return;
        
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            if (rides) {
                const ridesArray = Object.values(rides);
                let userRides = ridesArray.filter(r => r.userId === currentUser.id);
                let list = document.getElementById('historyList');
                
                if (userRides.length) {
                    list.innerHTML = userRides.reverse().map(r => `
                        <div class="history-item">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <strong>${r.pickup} ‚Üí ${r.dest}</strong>
                                <span style="color:var(--accent); font-weight:700;">R${r.amount}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; color:var(--text-sec); font-size:14px;">
                                <span>${r.distance} km ¬∑ ${r.duration || 'N/A'}</span>
                                <span>${r.time}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--text-sec); font-size:14px;">
                                <span>Status:</span>
                                <span style="color:${r.status === 'completed' ? 'var(--success)' : r.status === 'pending' ? 'var(--warning)' : 'var(--accent)'};">${r.status}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    let total = userRides.reduce((sum, r) => sum + r.amount, 0);
                    document.getElementById('totalSpent').innerHTML = `Total spent: <span style="color:var(--accent);">R${total}</span>`;
                } else {
                    list.innerHTML = '<div class="history-item">No trips yet</div>';
                    document.getElementById('totalSpent').innerHTML = '';
                }
            }
        });
    }

    // ========== PROFILE ==========
    function loadProfile() {
        if (!currentUser) return;
        
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            const userRides = rides ? Object.values(rides).filter(r => r.userId === currentUser.id) : [];
            
            let card = document.getElementById('profileCard');
            card.innerHTML = `
                <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px;">
                    <div class="avatar" style="width:70px; height:70px;">
                        ${currentUser.selfie ? 
                            `<img src="${currentUser.selfie}" style="width:100%; height:100%; object-fit:cover;">` : 
                            `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:var(--accent); font-size:24px;">${currentUser.name.charAt(0)}</div>`
                        }
                    </div>
                    <div>
                        <div style="font-size:20px; font-weight:700; margin-bottom:4px;">${currentUser.name}</div>
                        <div style="color:var(--text-sec);"><i class="fas fa-phone"></i> ${currentUser.phone}</div>
                        <div style="color:var(--text-sec); margin-top:4px;">Member since ${new Date(currentUser.createdAt || Date.now()).toLocaleDateString()}</div>
                    </div>
                </div>
                <div style="background:var(--surface); border-radius:20px; padding:16px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>Total rides:</span>
                        <span style="font-weight:700;">${userRides.length}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>Total distance:</span>
                        <span style="font-weight:700;">${userRides.reduce((s, r) => s + (r.distance || 0), 0)} km</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span>Total spent:</span>
                        <span style="font-weight:700; color:var(--accent);">R${userRides.reduce((s, r) => s + r.amount, 0)}</span>
                    </div>
                </div>
            `;
        });
    }

    // ========== AUTH ==========
    function updateAuthUI() {
        const homeAuthBtns = document.getElementById('homeAuthBtns');
        const homeProfile = document.getElementById('homeUserProfile');
        const homeName = document.getElementById('homeUserName');
        const homeAvatarImg = document.getElementById('homeAvatarImg');
        const homeInitials = document.getElementById('homeAvatarInitials');

        if (currentUser) {
            homeAuthBtns.style.display = 'none';
            homeProfile.style.display = 'flex';
            homeName.innerText = currentUser.name.split(' ')[0];
            
            if (currentUser.selfie) {
                homeAvatarImg.src = currentUser.selfie;
                homeAvatarImg.style.display = 'block';
                homeInitials.style.display = 'none';
            } else {
                homeAvatarImg.style.display = 'none';
                homeInitials.style.display = 'flex';
                homeInitials.innerText = currentUser.name.charAt(0);
            }
        } else {
            homeAuthBtns.style.display = 'flex';
            homeProfile.style.display = 'none';
        }
    }

    // Modal controls
    document.getElementById('homeLoginBtn').onclick = () => {
        document.getElementById('loginModal').classList.add('active');
    };
    
    document.getElementById('homeRegisterBtn').onclick = () => {
        document.getElementById('registerModal').classList.add('active');
    };
    
    document.getElementById('homeAdminBtn').onclick = () => showPage('adminPage');
    
    document.getElementById('closeLoginModal').onclick = () => {
        document.getElementById('loginModal').classList.remove('active');
        document.getElementById('loginName').value = '';
        document.getElementById('loginPhone').value = '';
    };
    
    document.getElementById('closeRegisterModal').onclick = () => {
        document.getElementById('registerModal').classList.remove('active');
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        selfieData = null;
    };

    // Selfie upload
    let selfieData = null;
    document.getElementById('regUploadBtn').onclick = () => document.getElementById('regSelfieInput').click();
    
    document.getElementById('regSelfieInput').onchange = function(e) {
        let file = e.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = (ev) => {
                selfieData = ev.target.result;
                document.getElementById('regSelfieImg').src = ev.target.result;
                document.getElementById('regSelfieImg').style.display = 'block';
                document.getElementById('regSelfiePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    };

    // Register
    document.getElementById('regSubmit').onclick = () => {
        let name = document.getElementById('regName').value.trim();
        let phone = document.getElementById('regPhone').value.trim();
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        if (!selfieData) {
            alert('Selfie is required');
            return;
        }
        
        let newUser = { 
            id: 'u' + Date.now(), 
            name: name, 
            phone: phone, 
            selfie: selfieData,
            createdAt: new Date().toISOString()
        };
        
        usersRef.child(newUser.id).set(newUser);
        currentUser = newUser;
        
        updateAuthUI();
        document.getElementById('registerModal').classList.remove('active');
        
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        selfieData = null;
        document.getElementById('regSelfieImg').style.display = 'none';
        document.getElementById('regSelfiePlaceholder').style.display = 'flex';
        
        alert('Registration successful! You are now logged in.');
    };

    // Login
    document.getElementById('loginSubmit').onclick = () => {
        let name = document.getElementById('loginName').value.trim();
        let phone = document.getElementById('loginPhone').value.trim();
        
        if (!name || !phone) {
            alert('Name and phone number are required');
            return;
        }
        
        usersRef.once('value', (snapshot) => {
            const users = snapshot.val();
            let foundUser = null;
            
            if (users) {
                for (let id in users) {
                    let u = users[id];
                    if (u.name.toLowerCase() === name.toLowerCase() && u.phone === phone) {
                        foundUser = u;
                        break;
                    }
                }
            }
            
            if (foundUser) {
                currentUser = foundUser;
                updateAuthUI();
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('loginName').value = '';
                document.getElementById('loginPhone').value = '';
                alert('Welcome back, ' + foundUser.name + '!');
            } else {
                alert('No account found with that name and phone number. Please register first.');
            }
        });
    };

    // Logout
    document.getElementById('logoutBtn').onclick = () => {
        currentUser = null;
        updateAuthUI();
        showPage('homePage');
        alert('Logged out successfully');
    };

    // ========== ADMIN ==========
    document.getElementById('enableNotificationsBtn').onclick = () => {
        Notification.requestPermission().then(perm => {
            if (perm === 'granted') {
                alert('‚úÖ Desktop notifications enabled! You will be alerted for new rides.');
                playNotificationSound();
            }
        });
    };

    document.getElementById('testNotificationBtn').onclick = () => {
        playNotificationSound();
        showToast('üîä Notification test', 'success');
        showDesktopNotification('Test Notification', 'This is how new ride alerts will appear');
    };

    document.getElementById('testFirebaseBtn').onclick = () => {
        alert('‚úÖ Firebase is connected! Your config is working.');
        showToast('Firebase connected successfully!', 'success');
    };

    document.getElementById('adminLoginPageBtn').onclick = () => {
        if (document.getElementById('adminCodeInput').value === '548755') {
            isAdminLoggedIn = true;
            document.getElementById('adminDashboard').style.display = 'block';
            
            ridesRef.once('value', (snapshot) => {
                const rides = snapshot.val();
                if (rides) {
                    renderAdminRides(Object.values(rides));
                }
            });
            
            showToast('üëã Welcome Admin! Real-time notifications active.', 'success');
            playNotificationSound();
        } else {
            alert('Invalid admin code');
        }
    };

    function renderAdminRides(ridesArray) {
        let pending = ridesArray.filter(r => r.status === 'pending');
        let list = document.getElementById('adminRideList');
        
        if (pending.length) {
            list.innerHTML = pending.map(r => `
                <div class="ride-item" style="margin-bottom:16px; border-left: 4px solid var(--notification);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <strong style="font-size:16px;">${r.pickup} ‚Üí ${r.dest}</strong>
                        <span style="background:var(--notification); padding:4px 12px; border-radius:20px; font-size:12px;">LIVE</span>
                    </div>
                    <p style="font-size:20px; font-weight:700; color:var(--accent); margin:8px 0;">R${r.amount}</p>
                    <p style="color:var(--text-sec); font-size:14px;">üë§ ${r.userName || 'Unknown'}</p>
                    <p style="color:var(--text-sec); font-size:14px;">üì± ${r.userPhone || ''}</p>
                    <p style="color:var(--text-sec); font-size:14px;">üìè ${r.distance} km ¬∑ ${r.duration || 'N/A'}</p>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="auth-btn" style="background:green; color:white; border:none; flex:1;" onclick="acceptRide('${r.id}')">‚úÖ Accept</button>
                        <button class="auth-btn" style="background:red; color:white; border:none; flex:1;" onclick="declineRide('${r.id}')">‚ùå Decline</button>
                    </div>
                </div>
            `).join('');
        } else {
            list.innerHTML = '<div class="ride-item" style="text-align:center; padding:30px;">No pending ride requests</div>';
        }
    }

    window.acceptRide = (rideId) => {
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            let rideKey = null;
            let ride = null;
            
            for (let key in rides) {
                if (rides[key].id === rideId) {
                    rideKey = key;
                    ride = rides[key];
                    break;
                }
            }
            
            if (rideKey && ride) {
                ride.status = 'accepted';
                ride.driverETA = document.getElementById('adminEtaSelect').value;
                
                ridesRef.child(rideKey).set(ride);
                
                showToast(`‚úÖ Ride accepted: ${ride.pickup} ‚Üí ${ride.dest}`, 'success');
            }
        });
    };

    window.declineRide = (rideId) => {
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            let rideKey = null;
            
            for (let key in rides) {
                if (rides[key].id === rideId) {
                    rideKey = key;
                    break;
                }
            }
            
            if (rideKey) {
                ridesRef.child(rideKey).remove();
                showToast(`‚ùå Ride declined`, 'warning');
            }
        });
    };

    document.getElementById('adminUpdateEta').onclick = () => {
        const eta = document.getElementById('adminEtaSelect').value;
        
        ridesRef.once('value', (snapshot) => {
            const rides = snapshot.val();
            
            for (let key in rides) {
                if (rides[key].status === 'accepted') {
                    rides[key].driverETA = eta;
                    ridesRef.child(key).set(rides[key]);
                }
            }
            
            alert(`ETA updated to ${eta} for all accepted rides`);
        });
    };

    // Initialize Maps when API loads
    window.initMaps = initMaps;
    
    // Call init when Google Maps is ready
    if (window.google) {
        initMaps();
    }

    // Initialize
    updateAuthUI();
})();
</script>
</body>
</html>
