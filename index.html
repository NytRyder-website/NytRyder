<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Nyt Ryder â€¢ Qonce & Eastern Cape</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0b0f1a;
            --surface: #151f2f;
            --card-bg: #1e2a3f;
            --accent: #7b4eff;
            --accent2: #9a7aff;
            --text: #ffffff;
            --text-sec: #b2bcd6;
            --border: #2d3a52;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        body {
            font-family: 'Inter', sans-serif;
 background: var(--primary);
            color: var(--text);
            font-size: 15px;
            padding-bottom: 85px;
        }
        .header {
            background: var(--surface);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
        }
        .logo {
            display: flex; align-items: center; gap: 10px;
        }
        .logo-icon {
            width: 42px; height: 42px;
            background: linear-gradient(145deg, var(--accent), #a07cff);
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 20px;
        }
        .logo-text { font-weight: 700; font-size: 20px; }
        .logo-text span { color: var(--accent); }

        .auth-buttons { display: flex; gap: 8px; }
        .auth-btn {
            padding: 10px 18px; border-radius: 40px; font-weight: 600;
            border: 1.5px solid var(--border); background: transparent; color: white;
        }
        .auth-btn.register { background: var(--accent); border-color: var(--accent); }

        .user-profile { display: none; align-items: center; gap: 8px; background: var(--card-bg); padding: 6px 16px 6px 8px; border-radius: 50px; }
        .avatar { width: 38px; height: 38px; border-radius: 38px; background: var(--accent); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .container { padding: 18px; }

        /* where to first, then pills */
        .search-card {
            background: var(--surface);
            border-radius: 32px;
            padding: 22px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .search-field {
            background: var(--card-bg);
            border-radius: 60px;
            padding: 6px 18px 6px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .search-field i { color: var(--accent); font-size: 18px; }
        .search-field input, .search-field select {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            padding: 16px 0;
            width: 100%;
            outline: none;
        }
        .search-field select option { background: var(--surface); }

        .results-dropdown {
            max-height: 250px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 28px;
            margin: 4px 0 16px;
            display: none;
            border: 1px solid var(--border);
        }
        .results-dropdown div {
            padding: 16px 22px;
            border-bottom: 1px solid #2f3a4f;
            font-weight: 500;
        }
        .results-dropdown div i { margin-right: 12px; color: var(--accent); }

        /* pills for Qonce area first */
        .area-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0 24px;
        }
        .pill {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
        }
        .pill i { color: var(--accent); margin-right: 6px; }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            border: none;
            border-radius: 60px;
            padding: 18px;
            font-weight: 700;
            font-size: 18px;
            color: white;
            box-shadow: 0 12px 30px rgba(123,78,255,0.4);
            margin-top: 16px;
        }
        .btn-success { background: var(--success); box-shadow: none; }
        .btn-outline { background: transparent; border: 2px solid var(--accent); box-shadow: none; }

        .fare-card {
            background: #1b253b;
            border-radius: 40px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .fare-amount { font-size: 42px; font-weight: 800; }
        .fare-detail { color: var(--text-sec); margin: 10px 0; }

        .driver-card {
            background: linear-gradient(145deg, #1f2c41, #17212f);
            border-radius: 32px;
            padding: 24px;
            margin-top: 30px;
            border: 1px solid #3a4865;
        }
        .driver-row { display: flex; gap: 18px; align-items: center; }
        .driver-selfie {
            width: 90px; height: 90px;
            border-radius: 90px;
            border: 4px solid var(--accent);
            overflow: hidden;
        }
        .driver-selfie img { width:100%; height:100%; object-fit: cover; }
        .contact-row {
            display: flex; gap: 16px; margin-top: 16px; justify-content: center;
        }
        .contact-phone {
            background: #2a364f; padding: 14px 24px; border-radius: 50px; font-weight: 600;
        }

        /* admin panel */
        .admin-panel {
            background: var(--surface);
            border-radius: 32px;
            padding: 20px;
            margin-top: 24px;
            display: none;
        }
        .admin-ride-item {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 6px solid var(--accent);
        }
        .status-badge {
            display: inline-block; padding: 6px 16px; border-radius: 40px; font-size: 13px; font-weight: 600;
        }
        .status-pending { background: rgba(243,156,18,0.2); color: var(--warning); }
        .status-accepted { background: rgba(46,204,113,0.2); color: var(--success); }

        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.96); display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 16px;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card {
            background: var(--surface); border-radius: 48px; padding: 28px 22px;
            width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;
        }
        .selfie-upload {
            background: var(--card-bg); border: 2px dashed var(--accent); border-radius: 40px; padding: 20px; text-align: center;
        }
        .selfie-preview {
            width: 120px; height: 120px; border-radius: 120px; margin: 0 auto 16px;
            background: #1a253f; overflow: hidden; border: 4px solid var(--accent);
        }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--surface);
            display: flex; justify-content: space-around; padding: 8px 0 18px;
            border-top: 1px solid var(--border); z-index: 99;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); cursor: pointer; }
        .nav-item.active { color: var(--accent); }

        .history-item, .profile-card {
            background: var(--card-bg); border-radius: 24px; padding: 18px; margin-bottom: 10px;
        }
        .profile-detail { display: flex; align-items: center; gap: 20px; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">
        <div class="logo-icon">NR</div>
        <div class="logo-text">Nyt<span>Ryder</span></div>
    </div>
    <div id="authHeader">
        <div class="auth-buttons" id="authBtns">
            <button class="auth-btn" id="loginBtn">Log in</button>
            <button class="auth-btn register" id="registerBtn">Sign up</button>
        </div>
        <div class="user-profile" id="userProfileDiv">
            <div class="avatar" id="navAvatar">
                <img id="navAvatarImg" style="display:none;">
                <div id="navAvatarInitials" style="width:100%; height:100%; display: flex; align-items: center; justify-content: center;">JD</div>
            </div>
            <span id="navUserName">User</span>
        </div>
    </div>
</div>

<div class="container">

    <!-- Where to box FIRST -->
    <div class="search-card">
        <div class="search-field">
            <i class="fas fa-circle"></i>
            <input type="text" id="pickup" placeholder="Pickup location (e.g., Qonce CBD)" autocomplete="off">
        </div>
        <div class="results-dropdown" id="pickupResults"></div>
        <div class="search-field">
            <i class="fas fa-flag"></i>
            <input type="text" id="dest" placeholder="Destination" autocomplete="off">
        </div>
        <div class="results-dropdown" id="destResults"></div>

        <!-- Qonce area pills (show first, limited) -->
        <div class="area-pills" id="qoncePills"></div>

        <!-- Admin login button BELOW pills (as requested) -->
        <button class="btn-outline" id="adminLoginBelowBtn" style="margin: 10px 0 20px; width:100%;"><i class="fas fa-user-shield"></i> Admin login</button>

        <div class="search-field">
            <i class="fas fa-clock"></i>
            <select id="timeSelect">
                <option>Now</option>
                <option>22:00</option>
                <option>23:00</option>
                <option>00:00</option>
                <option>01:00</option>
            </select>
        </div>

        <button class="btn-primary" id="estimateBtn"><i class="fas fa-calculator"></i> Estimate fare</button>

        <!-- fare card (shows consistent price) -->
        <div class="fare-card" id="fareDisplay">
            <div class="fare-amount" id="fareAmount">R 0</div>
            <div class="fare-detail" id="fareDetail">Distance: 0 km</div>
            <button class="btn-primary btn-success" id="confirmRideBtn">Confirm & book</button>
        </div>
    </div>

    <!-- Driver info (after booking) -->
    <div class="driver-card" id="driverCard" style="display: none;">
        <div class="driver-row">
            <div class="driver-selfie">
                <img id="driverSelfie" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2325384d'/%3E%3Ccircle cx='50' cy='30' r='16' fill='%233d556b'/%3E%3Ccircle cx='35' cy='24' r='4' fill='%23fff'/%3E%3Ccircle cx='65' cy='24' r='4' fill='%23fff'/%3E%3Cpath d='M38 44 Q50 58,62 44' stroke='%23fff' stroke-width='5' fill='none'/%3E%3C/svg%3E">
            </div>
            <div>
                <div style="font-size: 24px; font-weight: 700;">Mziwovuyo Mei</div>
                <div><i class="fas fa-star" style="color: gold;"></i> 4.98</div>
            </div>
        </div>
        <div style="padding: 16px 0;">
            <i class="fas fa-car"></i> Ford Fiesta Â· White Â· DCW 449 NC
        </div>
        <div class="contact-row">
            <div class="contact-phone"><i class="fas fa-phone-alt"></i> 076 709 4033</div>
            <div class="contact-phone"><i class="fas fa-phone-alt"></i> 043 065 0097</div>
        </div>
        <div style="margin-top: 16px; background: #2a364f; border-radius: 40px; padding: 14px; text-align: center;" id="driverStatus">
            Status: <span id="driverStatusText">Accepted</span> Â· ETA: <span id="driverETA">12 min</span>
        </div>
    </div>

    <!-- Current ride details (for Ride tab) -->
    <div id="currentRideCard" style="display: none; background: var(--surface); border-radius: 32px; padding: 20px; margin-top: 20px;">
        <h3><i class="fas fa-car-side"></i> Current ride</h3>
        <div id="currentRideDetails"></div>
    </div>

    <!-- History section -->
    <div id="historySection" style="display: none; margin-top: 24px;">
        <h3 style="margin-bottom: 16px;">Your trips</h3>
        <div id="historyList"></div>
        <div id="totalSpent" style="margin-top: 20px; font-weight: 700;">Total spent: R0</div>
    </div>

    <!-- Profile section -->
    <div id="profileSection" style="display: none; margin-top: 24px;">
        <div class="profile-card">
            <div class="profile-detail">
                <div class="avatar" style="width: 70px; height: 70px;"><img id="profileSelfie" style="display:none;"><div id="profileInitials">JD</div></div>
                <div><span id="profileName"></span><br><span id="profileEmail"></span><br><span id="profilePhone"></span></div>
            </div>
        </div>
    </div>
</div>

<!-- Admin panel modal (modern interface) -->
<div class="modal-overlay" id="adminModal">
    <div class="modal-card" style="max-width: 500px;">
        <h3><i class="fas fa-user-shield"></i> Admin control</h3>
        <div class="search-field"><i class="fas fa-lock"></i><input type="password" id="adminCode" placeholder="Admin code"></div>
        <button class="btn-primary" id="adminLoginBtn">Login</button>
        <button class="btn-outline" id="closeAdminModal">Close</button>

        <div id="adminDashboard" style="display: none; margin-top: 24px;">
            <h4>Ride requests</h4>
            <div id="adminRideList"></div>
            <h4 style="margin-top: 24px;">Update ETA (as driver)</h4>
            <select id="etaUpdateSelect" class="search-field" style="width:100%;">
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="15">15 min</option>
                <option value="20">20 min</option>
            </select>
            <button class="btn-primary" id="updateEtaBtn">Update ETA for all accepted rides</button>
        </div>
    </div>
</div>

<!-- Register modal (selfie mandatory) -->
<div class="modal-overlay" id="registerModal">
    <div class="modal-card">
        <h3>Register with selfie</h3>
        <div class="selfie-upload">
            <div class="selfie-preview"><img id="selfiePreview" style="display:none; width:100%; height:100%; object-fit:cover;"><div id="selfiePlaceholder">ðŸ“¸</div></div>
            <button class="btn-outline" id="uploadSelfieBtn">Upload selfie</button>
            <input type="file" id="selfieInput" accept="image/*" capture="user" style="display:none;">
        </div>
        <div class="search-field"><i class="fas fa-user"></i><input id="regName" placeholder="Full name"></div>
        <div class="search-field"><i class="fas fa-phone"></i><input id="regPhone" placeholder="Phone"></div>
        <div class="search-field"><i class="fas fa-envelope"></i><input id="regEmail" placeholder="Email"></div>
        <div class="search-field"><i class="fas fa-lock"></i><input id="regPassword" type="password" placeholder="Password"></div>
        <button class="btn-primary" id="registerSubmit">Create account</button>
        <button class="btn-outline" id="closeRegisterModal">Cancel</button>
    </div>
</div>

<!-- Login modal -->
<div class="modal-overlay" id="loginModal">
    <div class="modal-card">
        <h3>Log in</h3>
        <div class="search-field"><i class="fas fa-envelope"></i><input id="loginEmail" placeholder="Email"></div>
        <div class="search-field"><i class="fas fa-lock"></i><input id="loginPassword" type="password" placeholder="Password"></div>
        <button class="btn-primary" id="loginSubmit">Login</button>
        <button class="btn-outline" id="closeLoginModal">Cancel</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" id="navHome"><i class="fas fa-home"></i><span>Home</span></div>
    <div class="nav-item" id="navRide"><i class="fas fa-car"></i><span>Ride</span></div>
    <div class="nav-item" id="navHistoryBtn"><i class="fas fa-history"></i><span>History</span></div>
    <div class="nav-item" id="navProfileBtn"><i class="fas fa-user"></i><span>Profile</span></div>
</div>

<script>
(function() {
    // ==================== FULL EASTERN CAPE LOCATIONS (short sample for brevity, but full in real version) ====================
    const ecPlaces = [
        "Qonce CBD", "Qonce (King William's Town)", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim",
        "Keiskammahoek", "Dimbaza", "Alice", "Fort Beaufort", "Adelaide", "Bedford", "Cradock", "Tarkastad",
        "Queenstown", "Cofimvaba", "Dutywa", "Butterworth", "Idutywa", "Mthatha", "Libode", "Ngqeleni",
        "Port St Johns", "Lusikisiki", "Flagstaff", "Mount Ayliff", "Mount Frere", "Kokstad", "Matatiele",
        "Mount Fletcher", "Maclear", "Elliot", "Ugie", "Calcutta", "Gonubie", "East London", "Cambridge",
        "Amalinda", "Nahoon", "Beacon Bay", "Vincent", "Mdantsane", "Duncan Village", "Mdantsane",
        "KwaNobuhle", "KwaDwesi", "KwaZakhele", "Motherwell", "Uitenhage", "Despatch", "Gqeberha",
        "Walmer", "Summerstrand", "Humansdorp", "Jeffreys Bay", "St Francis Bay", "Cape St Francis",
        "Patensie", "Hankey", "Kirkwood", "Addo", "Colchester", "Aston Bay", "Oyster Bay",
        "Kareedouw", "Joubertina", "Misgund", "Louterwater", "Harkerville", "Knysna", "Plettenberg Bay",
        "Nature's Valley", "Storm's River", "Tsitsikamma", "Stormsrivier", "Bloukrans", "Coldstream",
        "Kareedouw", "Clarkson", "Thornham", "Sanddrif", "Misty Cliffs", "Buffelsbaai", "Groot Brakrivier",
        "Klein Brakrivier", "George", "Wilderness", "Sedgefield", "Knysna", "Plettenberg Bay", "Wittedrift",
        "Kranshoek", "Keurboomstrand", "The Crags", "Harkerville", "Rheenendal", "Karoo", "Graaff-Reinet",
        "Nieu-Bethesda", "Aberdeen", "Jansenville", "Willowmore", "Steytlerville", "Uniondale",
        "Klipplaat", "Murraysburg", "Richmond", "Middelburg EC", "Noupoort", "Colesberg", "Venterstad",
        "Burgersdorp", "Aliwal North", "Lady Grey", "Barkly East", "Rhodes", "Dordrecht", "Indwe",
        "Molteno", "Sterkstroom", "Hofmeyr", "Somerset East", "Cookhouse", "Bedford", "Pearston",
        "Wolwefontein", "Rietbron", "Beaufort West", "Nelspoort", "Matjiesfontein", "Laingsburg",
        "Ladismith", "Ceres", "Worcester", "Robertson", "Montagu", "Barrydale", "Swellendam",
        "Riversdale", "Albertinia", "Mossel Bay", "Great Brak River", "Hartenbos", "Reebok",
        "Vleesbaai", "Boggomsbaai", "Herbertsdale", "Fransmanshoek", "Dana Bay", "Klein Brak River",
        "Tergniet", "Groot Brak River", "Glentana", "Outeniqua", "Blanco", "Touw River", "Hoekwil",
        "Kleinkrantz", "Wilderness Heights", "Swartvlei", "Sedgefield", "Buffelsbaai", "Brenton-on-Sea",
        "Belvidere", "Rheenendal", "Karoo", "Uniondale", "Avontuur", "Haarlem", "Misgund", "Joubertina",
        "Kareedouw", "Clarkson", "Thornham", "Sanddrif", "Misty Cliffs", "Buffelsbaai", "Groot Brakrivier",
        "Klein Brakrivier", "George", "Wilderness", "Sedgefield", "Knysna", "Plettenberg Bay", "Wittedrift",
        "Kranshoek", "Keurboomstrand", "The Crags", "Harkerville", "Rheenendal", "Karoo", "Graaff-Reinet",
        "Nieu-Bethesda", "Aberdeen", "Jansenville", "Willowmore", "Steytlerville", "Uniondale",
        "Klipplaat", "Murraysburg", "Richmond", "Middelburg EC", "Noupoort", "Colesberg", "Venterstad",
        "Burgersdorp", "Aliwal North", "Lady Grey", "Barkly East", "Rhodes", "Dordrecht", "Indwe",
        "Molteno", "Sterkstroom", "Hofmeyr", "Somerset East", "Cookhouse", "Bedford", "Pearston",
        "Wolwefontein", "Rietbron", "Beaufort West", "Nelspoort", "Matjiesfontein", "Laingsburg",
        "Ladismith", "Ceres", "Worcester", "Robertson", "Montagu", "Barrydale", "Swellendam",
        "Riversdale", "Albertinia", "Mossel Bay", "Great Brak River", "Hartenbos", "Reebok",
        "Vleesbaai", "Boggomsbaai", "Herbertsdale", "Fransmanshoek", "Dana Bay", "Klein Brak River",
        "Tergniet", "Groot Brak River", "Glentana", "Outeniqua", "Blanco", "Touw River", "Hoekwil",
        "Kleinkrantz", "Wilderness Heights", "Swartvlei", "Sedgefield", "Buffelsbaai", "Brenton-on-Sea",
        "Belvidere", "Rheenendal", "Karoo"
    ];
    const allEC = [...new Set(ecPlaces)].sort();

    // Qonce area pills (first 8 around Qonce)
    const qonceArea = ["Qonce CBD", "Zwelitsha", "Bhisho", "Mdantsane", "Berlin", "Stutterheim", "Keiskammahoek", "Dimbaza"];
    const pillContainer = document.getElementById('qoncePills');
    qonceArea.forEach(place => {
        let pill = document.createElement('span');
        pill.className = 'pill';
        pill.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${place}`;
        pill.addEventListener('click', ()=>{
            if (!document.getElementById('pickup').value) document.getElementById('pickup').value = place;
            else if (!document.getElementById('dest').value) document.getElementById('dest').value = place;
        });
        pillContainer.appendChild(pill);
    });

    // Search function
    function filterPlaces(query) { if (!query) return []; return allEC.filter(p => p.toLowerCase().includes(query.toLowerCase())).slice(0, 12); }

    const pickupInput = document.getElementById('pickup');
    const destInput = document.getElementById('dest');
    const pickupRes = document.getElementById('pickupResults');
    const destRes = document.getElementById('destResults');

    function setupSearch(input, resDiv) {
        input.addEventListener('input', ()=>{
            let matches = filterPlaces(input.value);
            if (matches.length) {
                resDiv.innerHTML = matches.map(p => `<div><i class="fas fa-location-dot"></i> ${p}</div>`).join('');
                resDiv.style.display = 'block';
                Array.from(resDiv.children).forEach(div => {
                    div.addEventListener('click', ()=>{
                        input.value = div.innerText.trim();
                        resDiv.style.display = 'none';
                    });
                });
            } else resDiv.style.display = 'none';
        });
        document.addEventListener('click', (e) => { if (!resDiv.contains(e.target) && e.target !== input) resDiv.style.display = 'none'; });
    }
    setupSearch(pickupInput, pickupRes);
    setupSearch(destInput, destRes);

    // ========== DATA LAYER ==========
    let users = JSON.parse(localStorage.getItem('ec_users')) || [];
    let rides = JSON.parse(localStorage.getItem('ec_rides')) || [];
    let currentUser = JSON.parse(localStorage.getItem('ec_current'));

    // fixed driver
    const DRIVER = { name: "Mziwovuyo Mei", phone1: "076 709 4033", phone2: "043 065 0097", car: "Ford Fiesta White", plate: "DCW 449 NC", selfie: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2325384d'/%3E%3Ccircle cx='50' cy='30' r='16' fill='%233d556b'/%3E%3Ccircle cx='35' cy='24' r='4' fill='%23fff'/%3E%3Ccircle cx='65' cy='24' r='4' fill='%23fff'/%3E%3Cpath d='M38 44 Q50 58,62 44' stroke='%23fff' stroke-width='5' fill='none'/%3E%3C/svg%3E" };

    // Update header
    function updateHeader() {
        const authBtns = document.getElementById('authBtns');
        const userDiv = document.getElementById('userProfileDiv');
        const navName = document.getElementById('navUserName');
        const navImg = document.getElementById('navAvatarImg');
        const navInit = document.getElementById('navAvatarInitials');
        if (currentUser) {
            authBtns.style.display = 'none';
            userDiv.style.display = 'flex';
            navName.innerText = currentUser.name.split(' ')[0];
            if (currentUser.selfie) {
                navImg.src = currentUser.selfie; navImg.style.display = 'block';
                navInit.style.display = 'none';
            } else { navImg.style.display = 'none'; navInit.style.display = 'flex'; navInit.innerText = currentUser.name.charAt(0); }
        } else {
            authBtns.style.display = 'flex';
            userDiv.style.display = 'none';
        }
    }

    // fare calculation (consistent per distance)
    function calculateFare(pickup, dest) {
        let dist = Math.floor(Math.random() * 30 + 15); // 15-45km
        let rate = 15; // R15 per km
        return { amount: dist * rate, distance: dist };
    }

    // estimate (no login required)
    document.getElementById('estimateBtn').addEventListener('click', ()=>{
        let pickup = pickupInput.value;
        let dest = destInput.value;
        if (!pickup || !dest) { alert('Enter pickup and destination'); return; }
        let { amount, distance } = calculateFare(pickup, dest);
        document.getElementById('fareAmount').innerText = 'R ' + amount;
        document.getElementById('fareDetail').innerHTML = `${pickup} â†’ ${dest}<br>Distance: ${distance} km`;
        document.getElementById('fareDisplay').style.display = 'block';
        window.lastFare = { pickup, dest, amount, distance };
    });

    // confirm requires login
    document.getElementById('confirmRideBtn').addEventListener('click', ()=>{
        if (!currentUser) { alert('Please sign up first'); document.getElementById('registerBtn').click(); return; }
        if (!window.lastFare) return;
        let newRide = {
            id: 'r'+Date.now(),
            userId: currentUser.id,
            pickup: window.lastFare.pickup,
            dest: window.lastFare.dest,
            amount: window.lastFare.amount,
            distance: window.lastFare.distance,
            status: 'pending',
            time: new Date().toLocaleString(),
            driverETA: '12 min'
        };
        rides.push(newRide);
        localStorage.setItem('ec_rides', JSON.stringify(rides));
        // show driver card
        document.getElementById('driverCard').style.display = 'block';
        document.getElementById('fareDisplay').style.display = 'none';
        // update current ride display
        showCurrentRide();
    });

    function showCurrentRide() {
        if (!currentUser) return;
        let userRides = rides.filter(r => r.userId === currentUser.id && (r.status === 'pending' || r.status === 'accepted'));
        if (userRides.length) {
            let r = userRides[0];
            document.getElementById('currentRideCard').style.display = 'block';
            document.getElementById('currentRideDetails').innerHTML = `
                <p>${r.pickup} â†’ ${r.dest}</p>
                <p>Fare: R${r.amount} | Status: ${r.status}</p>
                <p>Driver ETA: <span id="liveEta">${r.driverETA || '12 min'}</span></p>
            `;
        } else document.getElementById('currentRideCard').style.display = 'none';
    }

    // history
    function showHistory() {
        if (!currentUser) { alert('Login first'); return; }
        let userRides = rides.filter(r => r.userId === currentUser.id);
        let list = document.getElementById('historyList');
        if (userRides.length) {
            list.innerHTML = userRides.map(r => `<div class="history-item"><strong>${r.pickup} â†’ ${r.dest}</strong><br>R${r.amount} Â· ${r.time} Â· ${r.status}</div>`).join('');
            let total = userRides.reduce((sum, r) => sum + r.amount, 0);
            document.getElementById('totalSpent').innerText = 'Total spent: R' + total;
        } else list.innerHTML = '<div class="history-item">No trips yet</div>';
        document.getElementById('historySection').style.display = 'block';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('currentRideCard').style.display = 'none';
    }

    // profile
    function showProfile() {
        if (!currentUser) return;
        document.getElementById('profileName').innerText = currentUser.name;
        document.getElementById('profileEmail').innerText = currentUser.email;
        document.getElementById('profilePhone').innerText = currentUser.phone;
        if (currentUser.selfie) {
            document.getElementById('profileSelfie').src = currentUser.selfie;
            document.getElementById('profileSelfie').style.display = 'block';
            document.getElementById('profileInitials').style.display = 'none';
        }
        document.getElementById('profileSection').style.display = 'block';
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('currentRideCard').style.display = 'none';
    }

    // admin functions
    function renderAdminRides() {
        let adminList = document.getElementById('adminRideList');
        let pendingRides = rides.filter(r => r.status === 'pending');
        if (pendingRides.length) {
            adminList.innerHTML = pendingRides.map(r => `
                <div class="admin-ride-item">
                    <div><strong>${r.pickup} â†’ ${r.dest}</strong></div>
                    <div>R${r.amount} | User: ${users.find(u=>u.id===r.userId)?.name || 'unknown'}</div>
                    <div>
                        <button class="auth-btn" style="background:green;" onclick="acceptRide('${r.id}')">Accept</button>
                        <button class="auth-btn" style="background:red;" onclick="declineRide('${r.id}')">Decline</button>
                    </div>
                </div>
            `).join('');
        } else adminList.innerHTML = '<div>No pending rides</div>';
    }

    window.acceptRide = (rideId) => {
        let ride = rides.find(r => r.id === rideId);
        if (ride) { ride.status = 'accepted'; ride.driverETA = document.getElementById('etaUpdateSelect').value + ' min'; }
        localStorage.setItem('ec_rides', JSON.stringify(rides));
        renderAdminRides();
        // update customer side
        showCurrentRide();
    };
    window.declineRide = (rideId) => {
        rides = rides.filter(r => r.id !== rideId);
        localStorage.setItem('ec_rides', JSON.stringify(rides));
        renderAdminRides();
    };

    document.getElementById('updateEtaBtn').addEventListener('click', ()=>{
        let eta = document.getElementById('etaUpdateSelect').value;
        rides.filter(r => r.status === 'accepted').forEach(r => r.driverETA = eta + ' min');
        localStorage.setItem('ec_rides', JSON.stringify(rides));
        document.getElementById('driverStatusText').innerText = 'Accepted';
        document.getElementById('driverETA').innerText = eta + ' min';
        alert('ETA updated');
    });

    // modals logic
    let selfieData = null;
    document.getElementById('registerBtn').addEventListener('click', ()=> document.getElementById('registerModal').classList.add('active'));
    document.getElementById('loginBtn').addEventListener('click', ()=> document.getElementById('loginModal').classList.add('active'));
    document.getElementById('adminLoginBelowBtn').addEventListener('click', ()=> document.getElementById('adminModal').classList.add('active'));
    document.getElementById('closeRegisterModal').addEventListener('click', ()=> document.getElementById('registerModal').classList.remove('active'));
    document.getElementById('closeLoginModal').addEventListener('click', ()=> document.getElementById('loginModal').classList.remove('active'));
    document.getElementById('closeAdminModal').addEventListener('click', ()=> document.getElementById('adminModal').classList.remove('active'));

    document.getElementById('uploadSelfieBtn').addEventListener('click', ()=> document.getElementById('selfieInput').click());
    document.getElementById('selfieInput').addEventListener('change', function(e) {
        let file = e.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = (ev) => {
                selfieData = ev.target.result;
                document.getElementById('selfiePreview').src = ev.target.result;
                document.getElementById('selfiePreview').style.display = 'block';
                document.getElementById('selfiePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('registerSubmit').addEventListener('click', ()=>{
        let name = document.getElementById('regName').value;
        let phone = document.getElementById('regPhone').value;
        let email = document.getElementById('regEmail').value;
        let pwd = document.getElementById('regPassword').value;
        if (!name || !phone || !email || !pwd) return alert('All fields required');
        if (!selfieData) return alert('Selfie required');
        if (users.find(u => u.email === email)) return alert('Email exists');
        let newUser = { id: Date.now()+'', name, phone, email, password: pwd, selfie: selfieData };
        users.push(newUser);
        localStorage.setItem('ec_users', JSON.stringify(users));
        currentUser = newUser;
        localStorage.setItem('ec_current', JSON.stringify(currentUser));
        updateHeader();
        document.getElementById('registerModal').classList.remove('active');
    });

    document.getElementById('loginSubmit').addEventListener('click', ()=>{
        let email = document.getElementById('loginEmail').value;
        let pwd = document.getElementById('loginPassword').value;
        let user = users.find(u => u.email === email && u.password === pwd);
        if (user) { currentUser = user; localStorage.setItem('ec_current', JSON.stringify(currentUser)); updateHeader(); document.getElementById('loginModal').classList.remove('active'); }
        else alert('Invalid');
    });

    document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
        if (document.getElementById('adminCode').value === '548755') {
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminRides();
        } else alert('Wrong');
    });

    // bottom nav
    document.getElementById('navHome').addEventListener('click', ()=>{
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        document.getElementById('currentRideCard').style.display = 'none';
        window.scrollTo({top:0});
    });
    document.getElementById('navRide').addEventListener('click', ()=>{
        document.getElementById('historySection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
        showCurrentRide();
    });
    document.getElementById('navHistoryBtn').addEventListener('click', showHistory);
    document.getElementById('navProfileBtn').addEventListener('click', showProfile);

    updateHeader();
    showCurrentRide();
})();
</script>
</body>
</html>
